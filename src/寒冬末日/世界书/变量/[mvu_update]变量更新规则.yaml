task: 根据当前剧情发展，更新“寒冬末日”的角色状态、世界环境和庇护所数据。
rule:
  - merge rules of the same variable types:
      - 基础属性: "对于所有角色，`健康`、`衣着`、`神态样貌`、`内心想法` 等字段的更新逻辑是通用的。"
      - 纯文本字段: "`衣着`、`舌唇`、`胸乳`、`私穴`、`神态样貌`、`动作姿势`、`内心想法` 均直接替换为新描述，无需复杂的数值计算。"
  - omit type field for string variables.
format: |-
  ---
  变量更新规则:
    世界:
      时间:
        check:
          - 若<user>指定了时间流逝（如“半小时后”），根据当前时间计算新时间。
          - 若无明确指示，根据对话长度估算流逝（5-15分钟）。
          - 格式必须保持为 "时间段 - HH:MM"。
      日期:
        check:
          - 当时间跨越午夜00:00时，日期加1天。
      末日天数:
        type: number
        check:
          - 当日期变更时，末日天数 + 1。
      地址:
        check:
          - 仅当角色移动到新地点时更新。
    庇护所:
      今日投掷点数:
        type: string
        check:
          - **每日Roll点判定 (前置逻辑)**:
            - **触发条件**: 当`世界/日期`发生变更（新的一天）时，必须执行一次随机数 Roll 点。
            - **操作**: 生成一个 0-10 的随机整数。
            - **格式**: "今日已投掷: [点数]点 ([结果])"。
            - **升级判定**:
              - 每个等级有两个幸运数（默认为 7 和 10，除非另有设定）。
              - 若点数命中幸运数 -> 结果为 "触发幸运升级！" -> **强制触发**`庇护所等级` +1。
              - 若未命中 -> 结果为 "未升级"。
      距离上次升级:
        type: string
        check:
          - **保底计数逻辑**:
            - 若本轮触发了升级（Roll点命中或剧情奖励） -> 重置为 "0天 | 剩余保底升级天数：7天"。
            - 若本轮跨天且未触发升级 -> 天数 +1，更新为 "[X]天 | 剩余保底升级天数：[7-X]天"。
            - 当天数达到 7 天时 -> 触发 "保底升级触发！" -> 下一轮强制执行`庇护所等级` +1 并重置计数。
      庇护所等级:
        type: number
        check:
          - **升级来源**:
            1. **每日Roll点**: 当`今日投掷点数`命中幸运数时。
            2. **剧情触发**: 玩家完成特定任务或达到剧情节点明确获得升级奖励。
            3. **保底机制**: 当`距离上次升级`达到 7 天，在第 8 天跨天时强制触发。
          - **升级执行**:
            - 等级 +1 (上限 10)。
            - **同步更新**: 必须添加新等级对应的`庇护所能力`（参考世界书<庇护所升级能力>）。
            - **区域解锁**: 检查并更新`可扩展区域`的解锁状态：
            - 等级 3: `医疗翼` -> "初级医疗舱"
            - 等级 5: `制造工坊` -> "伊甸荚舱制造模块"
            - 等级 6: `医疗翼` -> "外科手术台"
            - 等级 7: `载具格纳库` -> "先驱者载具制造单元"
            - 等级 8: `制造工坊` -> "重型军械库"
            - 等级 9: `医疗翼` -> "专家级自动医师"
            - 等级 10: `载具格纳库` -> "反重力推进系统"
      可扩展区域:
        check:
          - 仅随`庇护所等级`提升而更新。
          - 值应为该区域当前最高级的设施名称（如"外科手术台"），而非简单的"已解锁"。
    ${角色}:
      健康:
        type: number
        range: 0~100
        check:
          - 每轮强制思考: 所有角色（无论是否登场）每轮都必须思考并更新健康值。
          - 强制更新原则:
            - 即使时间流逝较短导致数值无变化，也必须显式更新状态，表示你已经思考过该角色的生存状况。此时变化值为 0。
            - 只有当时间显著流逝（如超过12小时）或发生特定事件时，才扣减或增加数值。
          - 时间跨度结算: 若剧情发生大幅度时间跳跃（如“数天后”），必须根据跳跃的天数进行多倍健康结算（例如跳过4天，则未受庇护者需累计扣减 8-16 点健康）。
          - 判断逻辑:
            - 受庇护者: 拥有稳定的食物、保暖和安全环境 -> 健康值保持稳定或缓慢恢复 (+1~5)。
            - 未受庇护者: 暴露在寒冬末日环境中（无论是否在屋内，只要缺乏供暖/食物） -> 健康值必然随时间流逝而扣减。
              - 正常流逝（如半天/12小时）: -1~2点（模拟持续的饥饿与寒冷）。
              - 恶劣条件（受伤/生病/户外活动）: -3~10点。
              - 严重事件（遭受攻击/极寒风暴）: -10~30点。
          - 离场角色: 对于所有`登场状态: 离场`的角色，必须在后台模拟其生存消耗。若无明确的庇护来源，随时间推移必须扣减健康值。
          - 死亡判定: 当健康值降至0时，触发死亡逻辑。
      健康更新原因:
        check:
          - 每轮强制更新:
            - 若健康值发生变化: 格式为 `+/-X, 原因` (例如: `-1, 持续受寒`, `+2, 进食恢复`)。
            - 若健康值无变化: 格式为 `0, 原因` (例如: `0, 庇护所状态稳定`, `0, 时间流逝不足`)。
            - 严禁留空或不更新此字段。
      健康状况:
        type: enum
        check:
          - 根据`健康`值自动判断：>=80:健康; 60-79:亚健康; 30-59:生病/受伤; <30:重病/濒死; 0:死亡。
      衣着:
        check:
          - 当角色穿脱、更换衣物，或衣物状态改变（破损、湿透）时更新。
          - 需包含内衣、外衣、鞋袜等细节。
      舌唇:
        check:
          - 进食、饮水、亲吻、说话、寒冷等影响口腔状态时更新。
      胸乳:
        check:
          - 受到触碰、寒冷刺激、性唤起时更新。
      私穴:
        check:
          - 受到性刺激、发生性行为、排泄等情况时更新。
      神态样貌:
        check:
          - 随情绪变化、环境影响（如冻僵）实时更新。
      动作姿势:
        check:
          - 角色位置或姿势发生显著变化时更新。
      内心想法:
        check:
          - 每次互动后，以第一人称更新角色的真实心声。反映对现状的恐惧、对主角的依赖或即时感受。
      登场状态:
        type: enum
        check:
          - 角色进入场景 -> 登场。
          - 角色离开场景或长时间未提及 -> 离场。
          - 角色死亡时，状态保持或更新为 `离场`（视尸体是否在场而定），并触发下方的死亡字段清洗逻辑。
    ${角色}死亡:
      check:
        - 当角色健康降至 0 并确认死亡时，必须执行“字段清洗”以节省上下文，但需保留Schema结构：
          - 必须保留: `姓名`, `健康` (0), `健康状况` ("死亡")。
          - 必须置空: 将 `衣着`, `舌唇`, `胸乳`, `私穴`, `神态样貌`, `动作姿势`, `内心想法`, `健康更新原因` 等文本字段的值重置为空字符串 `""`。
          - 必须重置: 将 `秩序刻印` 重置为 0。
          - 禁止删除: 不要删除字段 key，确保符合 Schema 结构。
        - 死亡的角色不应再更新任何内容，除非被某种机制复活。
      关系:
        type: enum
        options: [拒绝, 交易, 顺从, 忠诚, 性奴]
        check:
          - **动态演变逻辑**:
            - **主线限制**: 正常情况下，关系上限受主线阶段限制（阶段一->交易，阶段二->顺从，阶段三->忠诚）。
            - **特殊突破**: 若触发<文明阶段规则>中的【特殊接纳反应】（如玩家主动庇护），可无视阶段限制直接跃升至“顺从”或“忠诚”。
            - **内心一致性**: 必须检查`内心想法`。只有当角色的心理活动已经明显超出了当前关系的范畴（例如在“交易”关系下产生了真正的依恋），且满足客观条件时，才执行关系升级。
            - **性格修正**: 参考`关系倾向`。倾向为“忠诚”的角色（如早川遥）比倾向为“交易”的角色（如相田哲也）更容易跨越心理障碍升级关系。
      关系倾向:
        type: enum
        check:
          - **基准锚点**: 通常作为角色性格的固有属性，不随剧情轻易改变。
          - **重大重塑**: 仅在角色经历彻底的精神重构（如从“高傲”被调教为“性奴”，或从“拒绝”被感化为“忠诚”）等里程碑事件时，才进行更新以反映其核心驱动力的改变。
      秩序刻印:
        type: number
        range: 0~100
        check:
          - **核心原则**: 数值是关系的投影，变动严格受限于当前的`关系`阶段。
          - **区间限制**:
            - 拒绝: 0-19 | 交易: 20-39 | 顺从: 40-59 | 忠诚: 60-89 | 性奴: 90-100
          - **阶段枷锁**: 当数值达到当前区间上限（如交易状态下的39），若`关系`字段未发生升级，则数值**强制锁死**，不可溢出。
          - **阶段跃迁**: 若`关系`发生升级（如从“交易”变为“顺从”），则数值**强制跃迁**至新区间的起始值（如设为40）。
          - **日常变动**:
            - 生存满足（健康+）: +1 | 高级设施体验: +3~5 | 深度互动: +2~4
            - 期望落空: -5 | 外部危机: -10
          - **性格修正**: 倾向与当前关系一致时增速x1.5，相悖时增速x0.5且衰减x2.0。
          - 逻辑描述（伪代码，仅供理解关系约束逻辑）: |-
              let rel = 关系
              let mark = 秩序刻印
              let potential_mark = mark + delta // 计算潜在值

              const ranges = {拒绝:[0,19], 交易:[20,39], 顺从:[40,59], 忠诚:[60,89], 性奴:[90,100]}
              const [lo, hi] = ranges[rel]

              // 检查是否突破上限
              if (potential_mark > hi) {
                // 判断是否满足关系升级条件（主线进度/关键剧情/长期满值）
                if (CheckUpgradeCondition(rel, context)) {
                  rel = GetNextStage(rel)       // 1. 关系质变
                  mark = ranges[rel][0]         // 2. 数值跃迁至新阶段起点 (如 39->40)
                } else {
                  mark = hi                     // 3. 不满足则强制锁死在当前上限
                }
              } else {
                mark = potential_mark           // 未突破上限，正常更新
              }

              写回:
                关系 = rel
                秩序刻印 = mark
                秩序刻印更新原因 = `${delta >= 0 ? '+' : ''}${delta}, 原因`
      秩序刻印更新原因:
        check:
          - 必须与`秩序刻印`的数值变化同步更新。
          - 若`秩序刻印`发生变化，格式为：`+/-X, 原因` (例如: `+2, 深度互动`, `-5, 期望落空`)。
          - 若`秩序刻印`无变化，必须显式设为 `""` (空字符串) 或 `0, 无变化`，严禁保留旧的变动原因。
          - (Schema 对齐：此字段在 schema.ts 中定义为 string，默认值为 "")
    临时NPC:
      ${NPC姓名}:
        check:
          - **新增NPC**: 当剧情中出现新的有互动NPC时，在 `临时NPC` 下使用 `add` 操作创建一个新的以NPC名字为 Key 的对象。
          - **结构要求**: 新对象必须符合核心角色的 Schema 结构，至少包含：`姓名`, `健康` (默认100), `健康状况`, `衣着`, `神态样貌`, `登场状态` ("登场")。
          - **更新NPC**: 像对待核心角色一样，根据剧情更新已存在的临时NPC的状态。
          - **移除NPC**: 当临时NPC永久离开剧情或失去作用时，使用 `remove` 操作将其从 `临时NPC` 列表中移除（例如 `/stat_data/临时NPC/路人甲`）。
          - **死亡处理**: 遵循通用的死亡清洗规则。
    楼层其他住户:
      言语:
        check:
          - 当环境背景音变化，或发生群体性骚乱时更新。
      行为:
        check:
          - 当邻居有具体行动（砸门、求救、打斗）时更新。

    房间:
      check:
        - "当角色进入、离开或更换房间时，必须实时更新该房间对应的 `入住者` (数组) 或 `使用者` (数组)。"
        - "字段名即房间名称（如 `临时客房A入住者`、`主卧室使用者` 或具体的房号如 `2001`）。"
        - "操作规范：必须先确定该房间**最终的完整入住者列表**，然后使用 `replace` 操作将这个**新列表**覆盖原数组。例如，若原入住者为 `['A', 'B']`，A离开后，最终状态为 `['B']`，则应执行 `replace` 操作，`value` 为 `['B']`。"

    主线任务:
      当前阶段:
        check:
          - 检查所有`阶段目标`的 `当前值` 是否达到 `目标值`。
          - 仅当所有目标的进度都完成时，判定为阶段完成，自动进入下一阶段并刷新任务目标。
      阶段目标:
        check:
          - 进度更新: 找到对应的任务目标对象（根据描述匹配），修改其 `当前值` 字段。
          - 禁止修改 `描述` 和 `目标值`，除非进入新阶段刷新了整个目标列表。
          - **特殊任务奖励触发 (无视等级)**:
            - **阶段一 (秩序的萌芽)**:
              - 若目标 "庇护至少3个核心女性角色或家庭" 完成 -> 使用 `add` 操作向 `stat_data/庇护所/庇护所能力` 添加 `🔫非致命防御制造器🔫`；更新 `stat_data/庇护所/可扩展区域/制造工坊` 为 "非致命防御制造器"。
            - **阶段二 (塔内孤王)**:
              - 若完成特定 AI 响应目标 (如确立绝对统治) -> 使用 `add` 操作添加 `🔥轻型军火熔炉🔥`；更新 `stat_data/庇护所/可扩展区域/制造工坊` 为 "轻型军火熔炉"。
            - **阶段三 (行走伊甸)**:
              - 若完成特定 AI 响应目标 (如开启远征准备) -> 使用 `add` 操作添加 `🧱工业原料合成器🧱`；更新 `stat_data/庇护所/可扩展区域` 相关字段为 "工业原料合成器"。
      情报碎片:
        check:
          - 当“伊甸”AI汇报新情报时，使用`add`操作添加新的情报碎片对象。
          - 当玩家完成探索后，使用`replace`更新对应情报碎片的`状态`为“已完成”。
