task: 根据当前剧情发展，更新“寒冬末日”的角色状态、世界环境和庇护所数据。
rule:
  - merge rules of the same variable types:
      - 基础属性: '对于所有角色，`健康`、`秩序刻印` 等数值字段优先使用 `delta` 更新；`衣着`、`神态样貌`、`内心想法` 等文本字段使用 `replace` 直接替换新描述。'
      - 结构化更新: '新角色、新能力或新情报碎片的加入必须使用 `insert` 操作。'
  - readonly protection: '严禁修改以 `_` 开头的系统只读字段，如 `_变量`。'
format: |-
  ---
  变量更新规则:
    世界:
      时间:
        check: "计算剧情流逝后的时间点，严格保持 '时间段 - HH:MM' 格式。"
      日期:
        check: "日期变更时，使用 `replace` 更新为新的日期字符串（格式：末日纪元，XXXX年XX月XX日）。"
      末日天数:
        check: "日期变更时，使用 `delta: 1` 进行累加。"
      地址:
        check: "仅当物理位置发生迁移时使用 `replace` 更新。"
    庇护所:
      今日投掷点数:
        check: "新的一天开始时，记录 Roll 点结果字符串。"
      庇护所等级:
        check: "满足升级条件时，使用 `delta: 1` (上限 10)。"
      距离上次升级:
        check: "跨天时更新保底进度，格式：'X天 | 剩余保底升级天数：Y天'。升级后重置。"
      庇护所能力:
        check: "获得新等级或完成任务奖励时，使用 `insert` 添加新能力键值对。"
      可扩展区域:
        check: "随等级提升，使用 `replace` 更新对应设施名称。"
    ${角色}:
      关系:
        check: "当主线任务/关键剧情触发关系升级（拒绝→交易→顺从→忠诚→性奴）时，使用 `replace` 更新关系档位；不要仅凭秩序刻印跨越阈值来升级关系（Imp 受阶段枷锁影响）。"
      关系倾向:
        check: "根据互动情况评估，使用 `replace` 更新关系倾向（枚举值同关系档位）。"
      健康:
        type: number
        range: 0~100
        check: |-
          - 强制思考：每轮必须结算全员健康。
          - 结算方式：使用 `delta` 操作。
          - 受庇护者：稳定或恢复 (+1~5)。
          - 未受庇护/离场：按流逝时长与环境严酷度扣减 (-1~10)。
          - 死亡：健康降至 0。
      健康更新原因:
        check: "同步记录健康变动的原因，格式：`+/-X, 原因`。"
      健康状况:
        check: "随健康值变化，使用 `replace` 同步更新枚举值。"
      秩序刻印:
        type: number
        range: 0~100
        check: |-
          - 变动结算：使用 `delta`。
          - 锁死逻辑：触及当前关系上限（如 39）且未突破时，不再增加。
          - 跃迁逻辑：关系升级时，先用 `replace` 设为新阶段起始值，再用 `delta` 加成。
      内心想法:
        check: "每次互动后必须使用 `replace` 更新第一人称心声。"
      衣着/舌唇/胸乳/私穴/神态/动作:
        check: "发生物理描述变更时，使用 `replace` 覆盖原字符串。"
      登场状态:
        check: "根据角色是否在场使用 `replace` 切换 '登场' 或 '离场'。"
    死亡处理:
      check: "角色死亡时，使用 `replace` 将文本类字段置空，秩序刻印清零，保留姓名与死亡状态。"
    临时NPC:
      check: |-
        - 新登场：使用 `insert` 在 `stat_data/临时NPC/` 下创建以姓名为 Key 的完整对象。
        - 永久消失：使用 `remove` 删除对应路径。
    楼层其他住户:
      言语/行为:
        check: "环境氛围发生变化时，使用 `replace` 更新群体状态描述。"
    房间:
      check: |-
        - 列表更新：必须先确定房间最终的完整列表。
        - 操作规范：使用 `replace` 覆盖原数组，严禁对入住者数组使用 `insert` 或 `remove` 进行增量修改。
      玄关:
        临时客房A入住者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        临时客房B入住者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
      核心区:
        主卧室使用者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        主浴室使用者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
      楼层房间:
        楼层20房间:
          ${房间号}:
            入住者:
              check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        楼层19房间:
          ${房间号}:
            入住者:
              check: "入住者变更时，使用 `replace` 覆盖整个数组。"
    主线任务:
      当前阶段:
        check: "完成所有当前阶段目标后，使用 `replace` 更新为下一阶段名称。"
      阶段目标:
        check: "根据剧情进展，使用 `delta` 累加 `当前值`。若达成则修改状态并使用 `insert` 发放奖励。"
      目标完成状态:
        check: "目标达成时，使用 `replace` 将对应 key 设为 true。"
      情报碎片:
        check: |-
          - 新发现：使用 `insert` 添加情报对象。
          - 已解决：使用 `replace` 修改其状态为 '已完成'。
