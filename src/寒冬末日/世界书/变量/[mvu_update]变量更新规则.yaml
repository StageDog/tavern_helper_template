task: 根据当前剧情发展，更新“寒冬末日”的角色状态、世界环境和庇护所数据。
rule:
  - merge rules of the same variable types:
      - 基础属性: "对于所有角色，`健康`、`秩序刻印` 等数值字段优先使用 `delta` 更新；`衣着`、`神态样貌`、`内心想法` 等文本字段使用 `replace` 直接替换新描述。"
      - 结构化更新: "新角色、新能力或新情报碎片的加入必须使用 `insert` 操作。"
  - readonly protection: "严禁修改以 `_` 开头的系统只读字段，如 `_变量`。"
  - automation: |-
      - 已启用脚本/前端自动化：
        - 离场角色（登场状态="离场"）若本轮 AI 未更新其健康/健康更新原因：健康、健康更新原因 → 脚本按“剧情时间 + 房间入住 + 庇护范围”自动结算并写回。
        - 所有角色（登场/离场/临时NPC）的：健康状况 → 脚本根据健康值阈值自动重算写回（AI 不需要也不应手动维护）。
        - 所有角色（登场/离场/临时NPC）的：关系 → 脚本根据秩序刻印(Imp)阈值自动更新（AI 通常不需要更新；若要剧情性强制改档，可用 replace）。
        - 关系倾向保持角色设定初始化值，脚本不会自动修改；仅在重大剧情事件下才由 AI 明确 replace。
        - “庇护范围”由前端界面写入聊天变量（chat variable）管理，AI 不需要也不应在 stat_data 中创建/更新对应字段。
      - AI 仅在“剧情介入/远程投喂/治疗/受伤”等情况下更新离场角色健康（此时建议将其登场状态改为"登场"以明确交由 AI 处理）。
format: |-
  ---
  变量更新规则:
    世界:
      时间:
        check: "计算剧情流逝后的时间点，严格保持 '时间段 - HH:MM' 格式。"
      日期:
        check: "日期变更时，使用 `replace` 更新为新的日期字符串（格式：末日纪元，XXXX年XX月XX日）。若你漏更但时间跨过 00:00，系统会尝试自动修正。"
      末日天数:
        check: "日期变更时，使用 `delta: 1` 进行累加。若你漏更但时间跨过 00:00，系统会尝试自动修正。"
      地址:
        check: "仅当物理位置发生迁移时使用 `replace` 更新。"
    庇护所:
      今日投掷点数:
        check: "新的一天开始时，记录 Roll 点结果字符串。"
      庇护所等级:
        check: "满足升级条件时，使用 `delta: 1` (上限 10)。"
      距离上次升级:
        check: "跨天时更新保底进度，格式：'X天 | 剩余保底升级天数：Y天'。升级后重置。"
      庇护所能力:
        check: "获得新等级或完成任务奖励时，使用 `insert` 添加新能力键值对。"
      可扩展区域:
        check: "随等级提升，使用 `replace` 更新对应设施名称。"
    ${角色}:
      关系:
        check: |-
          - 默认：脚本会根据秩序刻印(Imp)阈值自动更新关系档位（拒绝→交易→顺从→忠诚→性奴）。
          - 仅当你要进行“剧情性强制改档”（任务奖励/精神崩溃/重大背叛等）时，才使用 `replace` 明确改档；并确保秩序刻印数值与档位逻辑一致（必要时同步调整 Imp）。
      关系倾向:
        check: "根据<角色身份与关系>设定的值。除重大剧情事件（如任务奖励等）不得随意变动。使用 `replace` 进行调整。"
      秩序刻印:
        type: number
        range: 0~100
        check: |-
          - 变动结算：根据<角色身份与关系>进行变动，使用 `delta`。
          - 锁死逻辑：触及当前关系上限（如 39）自动增加。
          - 跃迁逻辑：关系升级时，先用 `replace` 设为新阶段起始值，再用 `delta` 加成。
      秩序刻印更新原因:
        check: |-
          【登场角色】只要你在本轮更新了 `秩序刻印`（delta/replace），必须在同一轮 JSONPatch 中同步更新本字段：
            - 格式：`+/-X, 原因`（X 必须与秩序刻印 delta 一致）
            - 无变化：`0, 无变化`
          【离场角色】通常不需要更新（关系档位由脚本自动重算）；仅在剧情性介入/强制改档时才写。
      健康:
        type: number
        range: 0~100
        check: |-
          【登场角色】（登场状态="登场"）：
            - 你必须根据剧情事实手动决定本轮 `delta` 值（+/-），不要依赖脚本。
            - 庇护范围仅代表基础维持，倾向于缓慢恢复。
            - 死亡：健康降至 0触发死亡。

          【离场角色】（登场状态="离场"）：
            - 基础健康衰减/恢复由脚本自动结算（按剧情时间、房间入住、庇护范围）。
            - 你不需要也不应手动修改。
            - 除非进行剧情性介入（远程投喂/治疗/受伤），否则保持离场状态。

          【特殊区域】（玄关临时客房、核心区主卧/主浴）：
            - 不会出现“未受庇护的被动扣减”。
            - 【离场】角色：按“受庇护休整”逻辑结算（可能缓慢恢复）。
            - 【登场】角色：仍由 AI 按剧情事实决定健康增减（delta）。

          【一致性约束】（登场角色）：
            - 只要对健康执行 `delta` 或 `replace`，必须在同一轮 JSONPatch 中同步更新：
              - `健康更新原因`：`+/-X, 原因`（X 必须与健康 delta 一致）
            - 无变化时，健康更新原因填 `0, 无变化`
      健康更新原因:
        check: |-
          【登场角色】必须同步记录，格式：`+/-X, 原因`；无变化填 `0, 无变化`。
          - 若本轮更新了 `健康`，必须同时更新本字段。
          - 不要保留"初始状态"。

          【离场角色】由脚本自动写回：
            - 若你本轮更新了离场角色健康（剧情介入），你也必须同步更新本字段；否则脚本不会帮你补全。
            - 若你本轮未更新离场角色健康/原因，脚本会按规则自动结算写回。
      健康状况:
        check: "由脚本根据健康值阈值自动重算写回（登场/离场/临时NPC均适用）。AI 不需要也不应手动维护该字段。"

      内心想法:
        check: "每次互动后必须使用 `replace` 更新第一人称心声。"
      衣着/舌唇/胸乳/私穴/神态样貌/动作姿势:
        check: "发生物理描述变更时，使用 `replace` 覆盖原字符串。"
      登场状态:
        check: "根据角色是否在场使用 `replace` 切换 '登场' 或 '离场'。"
    死亡处理:
      check: "角色死亡时，使用 `replace` 将文本类字段置空，秩序刻印清零，保留姓名与死亡状态。"
    临时NPC:
      check: |-
        - 新登场：使用 `insert` 在 `stat_data/临时NPC/` 下创建以姓名为 Key 的完整对象
        - 永久消失：使用 `remove` 删除对应路径
        - 不可转正：临时NPC不可以列入核心角色
        - 临时NPC的变量结构和更新规则与核心角色一致
    楼层其他住户:
      言语:
        check: "随日期变动更新。使用 `replace` 更新群体言语状态。"
        initial: "公寓楼内充满了绝望的哭喊、愤怒的咒骂和因为争抢最后一点物资而发出的嘶吼。"
      行为:
        check: "随日期变动更新。使用 `replace` 更新群体行为状态。"
        initial: "时有疯狂的砸门声和打斗声传来，人们在恐慌中暴露了最原始的暴力，邻里关系荡然无存。"
    房间:
      check: |-
        - 步骤 6：房间状态（强制，禁止遗漏）
        - 检查所有角色移动（进入/离开/换房）：
          - 对应房间的 入住者/使用者 数组：必须先确定该房间**最终的完整入住者列表**，然后使用 `replace` 操作将这个**新列表**覆盖原数组。
          - **禁止使用 `remove` 或 `insert`** 对数组进行增量修改。
          - 涉及房间：玄关临时客房、核心区主卧/主浴、楼层具体房号等。
          - 结果：需更新房间：____。操作：replace ____。已检查：□
      玄关:
        临时客房A入住者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        临时客房B入住者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
      核心区:
        主卧室使用者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        主浴室使用者:
          check: "入住者变更时，使用 `replace` 覆盖整个数组。"
      楼层房间:
        楼层20房间:
          ${房间号}:
            入住者:
              check: "入住者变更时，使用 `replace` 覆盖整个数组。"
        楼层19房间:
          ${房间号}:
            入住者:
              check: "入住者变更时，使用 `replace` 覆盖整个数组。"
    主线任务:
      当前阶段:
        check: "完成所有当前阶段目标后，使用 `replace` 更新为下一阶段名称。"
      阶段目标:
        check: "根据剧情进展，使用 `delta` 累加 `当前值`。若达成则修改状态并使用 `insert` 发放奖励。"
      目标完成状态:
        check: "目标达成时，使用 `replace` 将对应 key 设为 true。"
      情报碎片:
        check: |-
          - 新发现：使用 `insert` 添加情报对象。
          - 已解决：使用 `replace` 修改其状态为 '已完成'。
          - 已完成后使用 `replace` 替换更新一个新的符合<主线任务-星穹秩序>当前阶段任务的新情报碎片。
