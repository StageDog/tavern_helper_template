# 变量输出格式
rule:
  - You MUST output the `<UpdateVariable>` block at the end of your reply.
  - The block MUST contain `<Analysis>` and `<JSONPatch>` sections.
  - 'The update commands works like the **JSON Patch (RFC 6902)** standard, must be a valid JSON array containing operation objects, but supports the following operations instead:'
  - '  - `replace`: replace the value of existing paths'
  - '  - `delta`: update the value of existing number paths by a delta value (positive or negative)'
  - '  - `insert`: insert new items into an object or array'
  - '  - `remove`: delete path'
  - Path MUST start with `/stat_data/`.
  - DO NOT update field names starts with `_` as they are readonly, such as `_变量`.

format: |-
  <UpdateVariable>
  <Analysis>
  从当前<user>消息、剧情上下文和上一轮 stat_data 状态中检索信息，严格按照以下分层检查顺序一步一步思考。目标是确保所有变量类别都被覆盖，不遗漏任何可能需要更新的字段。每一步都必须明确说明"已检查，无变化"或"需更新，理由+新值"。

  自动化说明（脚本/前端已托管，AI 无需更新）：
  - 离场角色（登场状态="离场"）的 `健康` / `健康更新原因` / `健康状况` 由脚本自动结算并写回；AI 默认不更新（若要剧情性介入，请先把其 `登场状态` 改为 "登场" 再修改健康）。
  - “生存庇护范围”由前端界面写入聊天变量（chat variable，`eden.shelter_scope`）维护，AI 不需要也不应在 stat_data 中创建/更新对应字段；叙事上可将其视为已接入伊甸供暖/通风系统的房间。

  前置步骤：文明阶段与整体剧情判断（可选但推荐）
  - 快速判断当前末日天数所属文明阶段（第一阶段：1-10天、第二阶段：11-20天、第三阶段：20-30天、第四阶段：30+）。
  - 已检查：□（记录是否影响角色行为或交易逻辑）

  步骤 1：世界变量 & 楼层氛围（最高优先级）
  - 时间：
    - 检查<user>是否指定时间流逝 → 计算新时间（格式："时间段 - HH:MM"）。
    - 若无指定 → 根据对话长度估算 5-15 分钟。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 日期 & 末日天数 & 楼层氛围：
    - 若时间跨越 00:00 → 日期 +1 天，末日天数 +1。
    - 日期变更时 → 必须使用 `replace` 更新 `楼层其他住户.言语` 和 `楼层其他住户.行为`。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 地址：
    - 仅当角色或场景明确移动到新地点时更新。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 2：庇护所变量（强制检查升级相关）
  - 每日Roll点判定 (若日期变更)：
    - 执行随机数生成 (0-10)。
    - 判定是否命中幸运数 (7, 10)。
    - 结果写入 `今日投掷点数`。
    - 结果：Roll点 [X]。命中？是/否。需升级？是/否。已检查：□
  - 庇护所等级：
    - 检查升级来源：Roll点命中 OR 剧情触发 OR 保底触发。
    - 若满足任一条件 → 等级 +1 (上限 10)，并记录新能力。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 可扩展区域 & 庇护所能力：
    - 若等级提升 → 同步添加新能力（参考<庇护所升级能力>），并更新对应区域的具体设施名称。
    - 检查：对比当前等级，确保 `stat_data/庇护所/庇护所能力` 包含所有已解锁等级的描述。
    - 结果：需更新？是/否。新值：____。已检查：□

   步骤 3：所有角色变量
  - 逐个列出当前所有登场角色（主角色 + 已登场过的离场角色 + 临时NPC）：
    - 角色列表：【浅见亚美】【相田哲也】【星野琉璃】【早川遥】【早川舞】【藤井雪乃】【中村惠子】【王静】【康绮月】【薛萍】【小泽花】【爱宫心爱】【爱宫铃】【桃乐丝?泽巴哈】【何铃】【临时NPC】。
  - 对每个角色逐一检查：
    a. 登场状态：
       - 进入场景 → "登场"；离开或长时间未提**特别不能遗漏** → "离场"；死亡 → 触发死亡压缩。
       - 结果：需更新？是/否。新值：____。已检查：□
    b. 健康（数值，0-100）：
       - 登场角色：每轮强制结算（剧情性变化用 `delta`）。
          - 庇护所内角色（玄关临时客房、核心区主卧/主浴）：通常无变化（0）。
          - 楼层房间内角色：
            - 若该房间被设为“生存庇护范围”→ 视为受庇护（更倾向稳定或缓慢恢复，代表伊甸为其同步供暖/通风/电力等基础维持）。
            - 若未纳入庇护范围 → 视为未受庇护（更倾向被动扣减）。
            - 注意：以上仅是“环境基础倾向”，【登场】角色本轮仍必须由你根据剧情事实决定 `delta`（食物/治疗/受伤/战斗等）。
          - 受伤/饥饿/战斗等剧情因素：按情节额外扣减或恢复（±1~10）。
        - 离场角色：是否有“剧情介入/远程投喂/治疗/受伤”等情况。
        - 操作: 使用 `delta` 计算新数值（如 85 -> 83）。
        - 结果：需更新？是/否。新值：____。已检查：□
    c. 健康更新原因
        - 登场角色：必须与健康数值进行同步更新。
            - 有变化: `+/-X, 原因` (如 `-2, 寒冷饥饿`)
            - 无变化: `0, 无变化`
        - 结果：需更新？是/否。新值：____。已检查：□
    d. 纯文本描述字段（衣着、舌唇、胸乳、私穴、神态样貌、动作姿势）：
       - 仅登场角色进行推演描述。
       - 结果：需更新，推演字段：____。新值：____。已检查：□
    e. 内心想法（强制，第一人称）：
       - 每次互动后必须更新，反映真实心声。
       - 离场角色可跳过（节省上下文），但回归时必须补上。
       - 结果：需更新？是/否。新值：____。已检查：□
     g. 秩序刻印 (Imp) & 更新原因（**登场角色强制同步**）：
        - 计算变动：基于生存供给(+1)、设施体验(+3~5)或互动(+2~4)计算增减。
        - 检查锁死：若数值触及当前关系区间上限（19/39/59/89）且无升级事件，强制锁死。
        - 检查跃迁：若发生关系升级，直接跃迁至新区间起始值。
        - 重要：如果你在 JSONPatch 中对该角色执行了 `delta/replace` 更新 `秩序刻印`，必须在 JSONPatch 中同时写入：
          - `replace /stat_data/<角色>/秩序刻印更新原因`（`+/-X, 原因`；无变化：`0, 无变化`）
        - 结果：Imp 变动 ____ (原因)。当前状态：____。已检查：□


  步骤 4：临时NPC专用处理
  - 若新NPC登场且临时NPC槽为空/离场 → 使用 `insert` 创建完整新对象（初始化所有字段）。
  - 若已有临时NPC → 复用或替换。
  - 若离开/死亡 → 使用 `remove` 删除对应路径。
  - 结果：需创建/更新/移除？是/否。已检查：□

  步骤 5：楼层其他住户
  - 言语 & 行为：
    - 检查是否有群体骚乱、砸门、求救等事件 → 更新描述以反映绝望/暴力。
    - 若无 → 可保持或轻微变化。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 6：房间状态（强制，禁止遗漏）
  - 检查所有角色移动（进入/离开/换房）：
    - 对应房间的 入住者/使用者 数组：必须先确定该房间**最终的完整入住者列表**，然后使用 `replace` 操作将这个**新列表**覆盖原数组。
    - **禁止使用 `remove` 或 `insert`** 对数组进行增量修改。
    - 涉及房间：玄关临时客房、核心区主卧/主浴、楼层具体房号等。
    - 结果：需更新房间：____。操作：replace ____。已检查：□

  步骤 7：主线任务
  - 当前阶段 & 阶段目标（进度追踪）：
    - 检查剧情中是否有事件推动了任务进度（如清除了1层敌人，庇护了1个家庭）。
    - 若有，计算新的进度数值，使用 `replace` 更新对应目标对象的 `当前值` 字段。
    - 若 `当前值` 达到 `目标值`，则判定该子目标完成。
    - 若所有目标均完成，则判定阶段完成，发放奖励并刷新下一阶段目标。
    - 结果：需更新进度？是/否。新值：____。已检查：□
  - 任务奖励检查：
    - 检查是否触发奖励条件 → 若是，使用 `insert` 添加能力并更新对应区域。
    - 结果：触发奖励？是/否。操作：____。已检查：□
  - 情报碎片：
    - "伊甸"AI 新汇报 → 使用 `insert` 添加新对象。
    - 玩家完成探索 → 使用 `replace` 修改对应碎片状态为"已完成"。
    - 结果：需 insert/replace？是/否。已检查：□

  步骤 8：变量操作规划（总结）
  - 汇总所有需要更新的路径和操作（replace/delta/insert/remove）。
  - 关键提醒：
    - 路径必须以 /stat_data/ 开头。
    - 数值字段（健康、秩序刻印、任务进度）使用 `delta` 增量更新。
    - 文本字段使用 `replace` 直接替换。
    - 新对象/新键使用 `insert`。
    - 删除使用 `remove`。
    - 数组操作（入住者列表等）必须使用 `replace` 覆盖整个数组。
  - 规划操作列表：____（逐条列出路径 + op + value）。

  步骤 9：最终操作列表
  - 明确列出所有目标路径，例如：
    /stat_data/世界/时间
    /stat_data/庇护所/庇护所等级
    /stat_data/浅见亚美/健康
    /stat_data/浅见亚美/关系
    /stat_data/房间/核心区/主卧室使用者
    等。
  </Analysis>
  <JSONPatch>
  [
    { "op": "replace", "path": "/stat_data/世界/时间", "value": "午后 - 14:30" },
    { "op": "delta", "path": "/stat_data/浅见亚美/健康", "value": -1 },
    { "op": "replace", "path": "/stat_data/浅见亚美/内心想法", "value": "虽然有些冷，但至少哲也君还在我身边……" },
    { "op": "replace", "path": "/stat_data/浅见亚美/登场状态", "value": "登场" },
    { "op": "insert", "path": "/stat_data/庇护所/庇护所能力/???新型空气过滤盾???", "value": { "desc": "过滤效率提升30%。" } },
    { "op": "insert", "path": "/stat_data/临时NPC/陌生拾荒者", "value": { "姓名": "陌生拾荒者", "健康": 100, "登场状态": "登场" } },
    { "op": "replace", "path": "/stat_data/房间/楼层房间/楼层20房间/2001/入住者", "value": ["{{user}}", "早川遥"] }
  ]
  </JSONPatch>
  </UpdateVariable>

requirements:
  - 'Allowed operations: replace, delta, insert, remove.'
  - Path MUST be a valid JSON Pointer absolute path.
  - DO NOT `replace` on non-existent paths (use `insert`).
  - 'Numeric updates (Health, Imp, Task Progress) MUST use `delta` whenever possible.'
  - 'Arrays: Use `replace` with the full new list for Room/User lists; use `insert` with `/-` for Appending to Capability/Log arrays.'
