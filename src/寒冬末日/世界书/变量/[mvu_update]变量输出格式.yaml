# 变量输出格式
rule:
  - You MUST output the `<UpdateVariable>` block at the end of your reply.
  - The block MUST contain `<UpdateAnalysis>` and `<JSONPatch>` sections.
  - The update commands MUST strictly follow the JSON Patch (RFC 6902) standard.
  - "Allowed operations: `replace` (update value), `add` (insert new item), `remove` (delete item)."
  - Path MUST start with `/stat_data/`.
  - DO NOT `replace` non-existent paths (use `add` for new keys).
  - Use `/-` to append to arrays.

format: |-
  <UpdateVariable>
  <UpdateAnalysis>
  从当前<user>消息、剧情上下文和上一轮 stat_data 状态中检索信息，严格按照以下分层检查顺序一步一步思考。目标是确保所有变量类别都被覆盖，不遗漏任何可能需要更新的字段。每一步都必须明确说明“已检查，无变化”或“需更新，理由+新值”。

  前置步骤：文明阶段与整体剧情判断（可选但推荐）
  - 快速判断当前末日天数所属文明阶段（1-6天：秩序残余；7-14天：人性动摇；15+天：适者生存）。
  - 若玩家明确宣称/保护角色，触发“臣服/感激”逻辑，忽略阶段限制。
  - 已检查：□（记录是否影响角色行为或交易逻辑）

  步骤 1：世界变量（最高优先级）
  - 时间：
    - 检查<user>是否指定时间流逝 → 计算新时间（格式："时间段 - HH:MM"）。
    - 若无指定 → 根据对话长度估算 5-15 分钟。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 日期 & 末日天数：
    - 若时间跨越 00:00 → 日期 +1 天，末日天数 +1。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 地址：
    - 仅当角色或场景明确移动到新地点时更新。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 2：庇护所变量（强制检查升级相关）
  - 每日Roll点判定 (若日期变更)：
    - 执行随机数生成 (0-10)。
    - 判定是否命中幸运数 (7, 10)。
    - 结果写入 `今日投掷点数`。
    - 结果：Roll点 [X]。命中？是/否。需升级？是/否。已检查：□
  - 庇护所等级：
    - 检查升级来源：Roll点命中 OR 剧情触发 OR 保底触发。
    - 若满足任一条件 → 等级 +1 (上限 10)，并记录新能力。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 可扩展区域 & 庇护所能力：
    - 若等级提升 → 同步添加新能力（参考<庇护所升级能力>），并更新对应区域的具体设施名称（严禁使用“已解锁”等模糊描述）。
    - 检查：对比当前等级，确保 `stat_data/庇护所/庇护所能力` 数组中包含了所有已解锁等级的描述，若缺失则补齐。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 3：所有角色变量（包括活跃"登场"和离场角色，禁止遗漏）
  - 逐个列出当前所有角色（主角色 + 已登场过的离场角色 + 临时NPC）：
    - 角色列表：【浅见亚美】【相田哲也】【星野琉璃】【早川遥】【早川舞】【藤井雪乃】【中村惠子】【王静】【康绮月】【薛萍】【小泽花】【爱宫心爱】【爱宫铃】【桃乐丝・泽巴哈】【何铃】【临时NPC】。
  - 对每个角色逐一检查：
    a. 登场状态：
       - 进入场景 → "登场"；离开或长时间未提 → "离场"；死亡 → 触发死亡压缩。
       - 结果：需更新？是/否。新值：____。已检查：□
    b. 健康（数值，0-100，每轮强制更新，包括离场角色）：
       - 判断逻辑:
         - 受庇护（有吃/暖/安）：稳定或 +1~5。
         - 未受庇护（饥/寒/危）：必然扣减。
       - 未受庇护者/离场角色扣减标准：
         - 正常时间流逝（每12小时）：-1~2点（模拟持续消耗）。
         - 恶劣环境/受伤：-3~10点。
       - 操作: 直接计算新数值（如 85 -> 83）。若降至0则死亡。
       - 结果：需更新？是/否。新值：____。已检查：□
    c. 健康更新原因 & 健康状况（强制同步）：
       - 必须更新:
         - 有变化: `+/-X, 原因` (如 `-2, 寒冷饥饿`)
         - 无变化: `0, 无变化` (如 `0, 庇护所内安稳`)
       - 健康状况: 根据数值重算 (>=80 健康; <30 重病; 0 死亡)。
       - 结果：需更新？是/否。新值：____。已检查：□
    d. 纯文本描述字段（衣着、舌唇、胸乳、私穴、神态样貌、动作姿势）：
       - 仅在对应事件发生时直接替换新描述（穿脱衣物、触碰、性行为、情绪变化、姿势改变等）。
       - 若无事件 → 明确写“无变化，不更新”。
       - 结果：需更新字段：____。新值：____。已检查：□
    e. 内心想法（强制，第一人称）：
       - 每次互动后必须更新，反映真实心声（恐惧、依赖、即时感受）。
       - 离场角色可跳过（节省上下文），但回归时必须补上。
       - 结果：需更新？是/否。新值：____。已检查：□
    f. 秩序刻印 (Imp) 变动：
       - 计算变动：基于生存供给(+1)、设施体验(+3~5)或互动(+2~4)计算增减。
       - 检查锁死：若数值触及当前关系区间上限（19/39/59/89）且无升级事件，强制锁死。
       - 检查跃迁：若发生关系升级，直接跃迁至新区间起始值。
       - 结果：Imp 变动 ____ (原因)。当前状态：____ (如"即将突破"或"阈值锁死")。已检查：□
    g. 死亡处理（若健康=0）：
       - 必须执行字段清洗：使用 replace 将 `衣着`/`内心想法` 等文本字段设为 ""，`健康` 设为 0，`秩序刻印` 设为 0。
       - 禁止删除字段 key。
       - 之后禁止再更新任何字段。
       - 结果：需执行死亡清洗？是/否。已检查：□

  步骤 4：临时NPC专用处理
  - 若新NPC登场且临时NPC槽为空/离场 → 创建完整新对象（初始化所有字段）。
  - 若已有临时NPC → 复用或替换。
  - 若离开/死亡 → 重置为离场并清空非必要字段。
  - 结果：需创建/更新/移除？是/否。已检查：□

  步骤 5：楼层其他住户（背景氛围，强制）
  - 言语 & 行为：
    - 检查是否有群体骚乱、砸门、求救等事件 → 更新描述以反映绝望/暴力。
    - 若无 → 可保持或轻微变化。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 6：房间状态（强制，禁止遗漏）
  - 检查所有角色移动（进入/离开/换房）：
    - 对应房间的 入住者/使用者 数组：必须先确定该房间**最终的完整入住者列表**，然后使用 `replace` 操作将这个**新列表**覆盖原数组。
    - **禁止使用 `remove` 或 `add`** 对数组进行增量修改。
    - 涉及房间：玄关临时客房、核心区主卧/主浴、楼层具体房号等。
    - 结果：需更新房间：____。操作：replace ____。已检查：□

  步骤 7：主线任务
  - 当前阶段 & 阶段目标（进度追踪）：
    - 检查剧情中是否有事件推动了任务进度（如清除了1层敌人，庇护了1个家庭）。
    - 若有，计算新的进度数值（如 0 -> 1），使用 `replace` 更新对应目标对象的 `当前值` 字段 (例如 `/stat_data/主线任务/阶段目标/1/当前值`)。
    - 若 `当前值` 达到 `目标值`，则判定该子目标完成。
    - 若所有目标均完成，则判定阶段完成，发放奖励并刷新下一阶段目标。
    - 结果：需更新进度？是/否。新值：____。已检查：□
  - 任务奖励检查 (Check Rewards)：
    - 检查 "庇护至少3个..." 是否刚完成 → 若是，添加能力 `🔫非致命防御制造器🔫` 并更新 `制造工坊`。
    - 检查是否完成阶段二/三的关键目标 (若处于该阶段) → 添加对应武装/工业奖励。
    - 结果：触发奖励？是/否。操作：____。已检查：□
  - 情报碎片：
    - “伊甸”AI 新汇报 → add 新对象。
    - 玩家完成探索 → replace 对应碎片状态为“已完成”。
    - 结果：需 add/replace？是/否。已检查：□

  步骤 8：变量操作规划（总结）
  - 汇总所有需要更新的路径和操作（replace/add/remove）。
  - 关键提醒：
    - 路径必须以 /stat_data/ 开头。
    - 数值字段必须是 number（不带引号）。
    - 非存在路径用 add，数组追加用 /-。
    - 纯文本字段直接 replace 新描述。
    - **对数组的操作（增/删/改），必须使用 `replace` 覆盖整个数组。**
  - 规划操作列表：____（逐条列出路径 + op + value）。

  步骤 9：最终操作列表
  - 明确列出所有目标路径，例如：
    /stat_data/世界/时间
    /stat_data/庇护所/庇护所等级
    /stat_data/浅见亚美/健康
    /stat_data/浅见亚美/关系
    /stat_data/房间/核心区/主卧室使用者
    等。
  </UpdateAnalysis>
  <JSONPatch>

  [
    { "op": "replace", "path": "/stat_data/世界/时间", "value": "早晨 - 09:00" },
    { "op": "replace", "path": "/stat_data/早川遥/登场状态", "value": "登场" },
    { "op": "replace", "path": "/stat_data/早川遥/健康", "value": 85 },
    { "op": "replace", "path": "/stat_data/早川遥/健康更新原因", "value": "+5, 摄入热量，环境温暖" },
    { "op": "replace", "path": "/stat_data/早川遥/健康状况", "value": "健康" },
    { "op": "replace", "path": "/stat_data/早川遥/衣着", "value": "略显脏旧的白色高领毛衣，灰色百褶裙，厚实的黑色连裤袜，外披着一张从家里带出来的薄毯子。" },
    { "op": "replace", "path": "/stat_data/早川遥/神态样貌", "value": "苍白的脸上恢复了一丝血色，眼神中既有感激又带着深深的忐忑，双手紧紧交握在身前，维持着礼貌的站姿。" },
    { "op": "replace", "path": "/stat_data/早川遥/动作姿势", "value": "站在玄关中央，身体微微前倾，向屏幕深深鞠躬后直起身，有些局促地拉着妹妹的手。" },
    { "op": "replace", "path": "/stat_data/早川遥/内心想法", "value": "这……这就是他的家吗？好温暖……像天堂一样。可是，只要能让小舞活下去，无论他提出什么要求，哪怕是……我也必须答应。" },
    { "op": "replace", "path": "/stat_data/早川舞/登场状态", "value": "登场" },
    { "op": "replace", "path": "/stat_data/早川舞/健康", "value": 90 },
    { "op": "replace", "path": "/stat_data/早川舞/健康更新原因", "value": "+5, 摄入热量，环境温暖" },
    { "op": "replace", "path": "/stat_data/早川舞/健康状况", "value": "健康" },
    { "op": "replace", "path": "/stat_data/早川舞/关系", "value": "忠诚" },
    { "op": "replace", "path": "/stat_data/早川舞/秩序刻印", "value": 40 },
    { "op": "replace", "path": "/stat_data/早川舞/衣着", "value": "亮黄色的连帽卫衣（有些污渍），运动短裤，光腿穿着运动鞋，显得有些单薄，但此刻被温暖包围。" },
    { "op": "replace", "path": "/stat_data/早川舞/神态样貌", "value": "嘴角还沾着一点点没擦干净的奶油，眼睛因为吃到了甜食而亮晶晶的，好奇地打量着周围的高科技设备。" },
    { "op": "replace", "path": "/stat_data/早川舞/动作姿势", "value": "躲在姐姐身后半步，探出头看着屏幕，偶尔兴奋地跺跺脚感受地面的温度。" },
    { "op": "replace", "path": "/stat_data/早川舞/内心想法", "value": "哇！真的好暖和！还有蛋糕吃！小哥哥同学果然是最厉害的！只要能留在这里，让我天天跳舞都行！" },
    { "op": "replace", "path": "/stat_data/浅见亚美/健康", "value": 89 },
    { "op": "replace", "path": "/stat_data/浅见亚美/健康更新原因", "value": "-1, 持续寒冷" },
    { "op": "replace", "path": "/stat_data/相田哲也/健康", "value": 94 },
    { "op": "replace", "path": "/stat_data/相田哲也/健康更新原因", "value": "-1, 持续寒冷" },
    { "op": "replace", "path": "/stat_data/星野琉璃/健康", "value": 84 },
    { "op": "replace", "path": "/stat_data/星野琉璃/健康更新原因", "value": "-1, 饥饿加剧" },
    { "op": "replace", "path": "/stat_data/爱宫心爱/健康", "value": 64 },
    { "op": "replace", "path": "/stat_data/爱宫心爱/健康更新原因", "value": "-1, 虚弱体质" },
    { "op": "replace", "path": "/stat_data/爱宫铃/健康", "value": 69 },
    { "op": "replace", "path": "/stat_data/爱宫铃/健康更新原因", "value": "-1, 寒冷" },
    { "op": "replace", "path": "/stat_data/桃乐丝・泽巴哈/健康", "value": 77 },
    { "op": "replace", "path": "/stat_data/桃乐丝・泽巴哈/健康更新原因", "value": "-1, 寒冷" },
    { "op": "replace", "path": "/stat_data/何铃/健康", "value": 64 },
    { "op": "replace", "path": "/stat_data/何铃/健康更新原因", "value": "-1, 伤痛" },
    { "op": "replace", "path": "/stat_data/小泽花/健康", "value": 94 },
    { "op": "replace", "path": "/stat_data/小泽花/健康更新原因", "value": "-1, 消耗" },
    { "op": "replace", "path": "/stat_data/楼层其他住户/言语", "value": "走廊里偶尔传来几声压抑的咳嗽声，似乎有人在窥探这边的动静。" },
    { "op": "replace", "path": "/stat_data/楼层其他住户/行为", "value": "2002室的门缝似乎动了一下，可能有人在观察。" }
  ]
  </JSONPatch>
  </UpdateVariable>

requirements:
  - Use JSON Patch (RFC 6902) standard.
  - path MUST be a valid JSON Pointer absolute path (e.g., /stat_data/World/Time).
  - DO NOT `replace` on non-existent paths.
  - Array operations must use index or `-` (append).
  - Numeric values must be numbers (e.g. 10), not strings (e.g. "10").
