# 寒冬末日：前端/脚本/变量系统开发记录（给后续 AI 调试与复用）

本文档记录本项目中「寒冬末日」相关的**时间系统**、**健康结算**、**庇护范围**、**界面注入解析**、以及关键工具函数与脚本的使用方式，方便后续 AI 维护、调试与扩展。

> 约定：不要直接改 `dist/**`（构建产物）。修改请在 `src/**` 完成后执行构建。

---

## 1) 关键文件导航

### 1.1 纯工具函数（无酒馆副作用）

- `src/寒冬末日/util/time.ts`：解析 `世界.日期/时间`，并计算跨轮的时间差（小时）
- `src/寒冬末日/util/room.ts`：根据 `stat_data.房间` 结构定位角色位置（玄关/核心区/楼层房间/未知）
- `src/寒冬末日/util/shelter_scope.ts`：庇护范围容量规则、scope 归一化、判定某房间是否被庇护
- `src/寒冬末日/util/health.ts`：离场健康变化算法、健康数值裁剪、健康状况映射

### 1.2 前端状态（chat 变量双向同步）

- `src/寒冬末日/界面/shelterScopeStore.ts`：`eden.shelter_scope` + `eden.rules.health` 的 Pinia store（chat 变量）
- `src/寒冬末日/界面/状态栏/components/ShelterSection.vue`：地图与庇护范围 UI（2001 禁止设置庇护；编辑面板在地图下方）
- `src/寒冬末日/界面/store.ts`：状态栏界面读取 MVU 的 `stat_data`（message 变量）并用 Zod Schema 兜底默认值

### 1.3 酒馆助手脚本（后台脚本）

- `src/寒冬末日/脚本/离场健康结算/index.ts`：监听 MVU 变量更新事件，自动结算离场角色健康
- `src/寒冬末日/脚本/日期逻辑/index.ts`：跨午夜自动补 `世界.日期/末日天数` 的独立版本（同逻辑已整合进“离场健康结算”，保留此脚本仅用于拆分职责/兼容旧部署）
- `src/寒冬末日/脚本/变量结构/index.ts`：向 MVU 注册 Zod Schema（用于变量初始化/校验的基准）

### 1.4 正文/选项注入与 `image###...###` 归一化

- `src/寒冬末日/界面/状态栏/useInjectedData.ts`：读取当前楼层消息原文 `raw` + 解析 `option` 列表
- `src/寒冬末日/界面/状态栏/components/StorySection.vue`：对 `raw` 做规范化（缺 `<content>` 时走 B 策略；把正文外的 `image###...###` 移入 `<content>/<game>`）

### 1.5 世界书规则（AI 输出约束）

- `src/寒冬末日/世界书/变量/[mvu_update]变量输出格式.yaml`
- `src/寒冬末日/世界书/变量/[mvu_update]变量更新规则.yaml`
- `src/寒冬末日/世界书/变量/[mvu_update]变量列表.yaml`：调试/展示用片段（在楼层里快速打印当前 `stat_data`）
- `src/寒冬末日/schema.ts`：`stat_data` 的 Zod Schema（字段结构、默认值与范围约束）

---

## 2) 数据从哪里来：MVU 与 chat 变量的分工

### 2.1 MVU（消息楼层变量，`stat_data`）

剧情输出通过 MVU 更新 `stat_data`（示例见开局文本中的 `<UpdateVariable><initvar>...</initvar>`）。

与本文档相关的关键路径：

- `stat_data.世界.日期`：例 `末日纪元，9527年12月14日`
- `stat_data.世界.时间`：例 `午后 - 14:00`
- `stat_data.房间`：用于定位角色是否在庇护所/楼层房间
- 各角色对象：至少包含
  - `健康`（0~100）
  - `健康更新原因`（形如 `+/-X, 原因` 或 `0, 无变化`）
  - `健康状况`（由数值映射：健康/亚健康/生病/受伤/重病/濒死/死亡）
  - `登场状态`（`登场` 或 `离场`）

### 2.2 MVU 结构校验：Zod Schema 与注册脚本

- `src/寒冬末日/schema.ts` 定义了本项目 `stat_data` 的完整结构（带 `prefault` 默认值与范围裁剪）。
- `src/寒冬末日/脚本/变量结构/index.ts` 会在酒馆启动脚本时调用 `registerMvuSchema(Schema)`，把该结构注册给 MVU（用于初始化/校验口径统一）。

> 经验：只要改动了 `schema.ts`，就应同时重新构建并更新该脚本的部署版本，避免“UI/脚本按新 schema 解析，但 MVU 仍按旧 schema 初始化”的错配。

### 2.3 推荐的 MVU 读写方式：`defineMvuDataStore`

如果需要在**前端界面内直接读写 MVU 的 `stat_data`**（例如把某些“可确定的机械变量”交给前端更新），推荐使用项目提供的 Pinia 工具：

- `src/util/mvu.ts`：`defineMvuDataStore(schema, variable_option, additional_setup?)`

特点：

- 基于 `zod` schema 做校验与默认值兜底
- 通过 `watchIgnorable + useIntervalFn` 实现：
  - 酒馆变量 → 前端 store 的同步
  - 前端修改 → 回写到酒馆变量（`updateVariablesWith(..., variable_option)`）

提示：

- 在消息 iframe 内做楼层级 MVU 读写时，`variable_option.type = 'message'` 且 `message_id = getCurrentMessageId()`（或 `latest` 映射为 `-1`）

本项目当前状态栏界面采用更轻量的“只读同步”方式：见 `src/寒冬末日/界面/store.ts`（监听 `Mvu.events.*` 并 `Schema.parse`）。若后续要在界面里**回写** `stat_data`，再切换到 `defineMvuDataStore` 会更省心。

### 2.4 chat 变量（跨楼层、跨轮复用的“配置/状态”）

本项目把**庇护范围**和**离场健康规则**放在 chat 变量里（避免塞进 `stat_data`，也方便脚本读取）：

- `eden.shelter_scope`：形如 `{ "20": ["2002","2003"], "19": ["1901"] }`
  - **注意：`2001` 永远不允许写入 scope（庇护所本体）**
- `eden.rules.health`：形如 `{ decayPer6h, recoverPer12h, decayMultiplier, recoverMultiplier }`
  - 当前状态栏 UI 未提供面板让玩家直接调整（避免“金手指”）；但 store 侧已支持读写与 sanitize，未来如需开放入口可直接复用
  - 脚本默认：`decayPer6h = 5`，`recoverPer12h = 1`，倍率默认 `1`

---

## 3) 世界时间系统：如何驱动“按小时结算”

### 3.1 解析规则（`src/寒冬末日/util/time.ts`）

`diffWorldHours(oldWorld, newWorld)` 读取：

- `oldWorld.日期` / `oldWorld.时间`
- `newWorld.日期` / `newWorld.时间`

返回值：

- `null`：解析失败或时间没有前进
- `number`：时间前进了多少小时（允许小数，例如 `0.5`）

日期格式要求（正则）：

- `(\d{1,4})年(\d{1,2})月(\d{1,2})日`（前缀如 `末日纪元，` 可有可无）

时间格式要求（正则）：

- 能匹配到 `HH:MM` 即可（前缀如 `午后 -` 可有可无）

### 3.2 触发条件

离场健康脚本只在 `世界.日期/时间` **向前推进**时结算；若本轮 AI 没推进世界时间，脚本不会动任何健康值。

午夜踩坑说明：

- 如果 AI 把时间从 `23:xx` 推进到 `01:xx` 但**忘了把日期 +1**，则 `diffWorldHours` 会认为时间没有前进（返回 `null`），离场健康不会结算。
- 这时依赖 `src/寒冬末日/脚本/日期逻辑/index.ts` 自动补日期；但多个脚本都监听 `VARIABLE_UPDATE_ENDED`，执行先后可能影响当轮是否能结算。
- 最稳妥做法仍是：AI 在跨越 00:00 时同步更新 `世界.日期` 与 `世界.末日天数`。

建议（给 AI 的提示）：

- 如果希望离场健康稳定按时间流逝结算，每轮都应在 MVU 输出中推进 `世界.时间`（必要时跨日推进 `世界.日期`）。

---

## 4) 健康值系统：离场自动结算（脚本接管）

### 4.1 纯算法（`src/寒冬末日/util/health.ts`）

#### 数值范围

- `clampHealth(v)`：裁剪到 `0~100`

#### 健康状况映射

- `<= 0`：`死亡`
- `< 30`：`重病/濒死`
- `< 60`：`生病/受伤`
- `< 80`：`亚健康`
- `>= 80`：`健康`

#### 离场健康变化（按步进结算）

`computeOffstageHealthDelta(deltaHours, sheltered, rules)`：

- **受庇护**：每满 `12` 小时结算一次恢复（步进 `floor(deltaHours/12)`）
  - `delta = steps * recoverPer12h * recoverMultiplier`
- **未受庇护**：每满 `6` 小时结算一次扣减（步进 `floor(deltaHours/6)`）
  - `delta = -steps * decayPer6h * decayMultiplier`

`reason` 的格式为：

- `+X, 离场受庇护休整`
- `-X, 离场未受庇护自然衰减`
- 或 `0, 无变化`

> 备注：这是“基础环境结算”。剧情介入（投喂/治疗/受伤/战斗等）仍应由 AI 负责，尤其是**登场角色**。

### 4.2 离场健康脚本（`src/寒冬末日/脚本/离场健康结算/index.ts`）

脚本行为要点：

1. 监听 `Mvu.events.VARIABLE_UPDATE_ENDED`
2. 计算跨轮时间差：`deltaHours = diffWorldHours(oldWorld, newWorld)`
3. 读取 chat 变量：
   - `eden.shelter_scope`（庇护范围）
   - `eden.rules.health`（结算规则；默认 `decayPer6h=5`）
4. 遍历 `stat_data` 中的角色对象（排除保留键：`世界/庇护所/房间/主线任务/楼层其他住户/临时NPC`）
5. **只处理 `登场状态 === '离场'` 的角色**
6. **只要 AI 在本轮改动了该角色的 `健康` 或 `健康更新原因`**，脚本就视为“剧情介入”，本轮不做“离场基础结算”（避免覆盖 AI 的剧情性增减）
   - 注意：脚本仍会把 `健康状况` 重算为与数值一致（因此 AI 不应手动维护 `健康状况`）
7. 离场基础结算写回字段（仅在满足步进且 `computed.delta != 0` 时写回）：
   - `健康`
   - `健康更新原因`（标准格式；若数值被 clamp 后导致实际变化为 0，会写入 `0, 无变化`）
8. 派生字段写回（对登场/离场/临时NPC都生效）：
   - `健康状况`：按 `健康` 阈值重算（必要时写回）
   - `关系`：按 `秩序刻印` 阈值重算（但若 AI 本轮明确更新了 `关系`，脚本不覆盖）
9. 控制台日志：当离场基础结算实际写回时输出
   - 形如：`[离场健康结算] 早川舞: 45 → 40 (-5, 离场未受庇护自然衰减)`

### 4.3 “是否受庇护”的判定（脚本使用）

脚本通过 `findRoleLocation(stat_data.房间, roleName)` 定位角色位置：

- `entrance`（玄关/临时客房A/B）：受庇护
- `core`（主卧/主浴）：受庇护
- `floor`（19/20 楼层房间）：
  - `20-2001`：**视为庇护所本体**（受庇护）
  - 其他房间：由 `eden.shelter_scope` 决定
- `none`：未受庇护

---

## 5) 庇护范围系统：容量规则 + 操作方式

### 5.1 scope 数据结构（chat 变量）

`eden.shelter_scope`：

```json
{
  "20": ["2002", "2004", "2007"],
  "19": ["1901"]
}
```

规则：

- `normalizeScope()` 会去重、排序、过滤空字符串，并且**强制过滤 `20-2001`**
- UI 也会阻止对 `2001` 的点击切换

### 5.2 容量规则（`src/寒冬末日/util/shelter_scope.ts`）

`floorRoomCapacity(level, floor)`：

- 20 层：
  - `lv < 3`：0
  - `lv = 3`：3
  - `lv = 4`：6
  - `lv >= 5`：12（封顶）
- 19 层：
  - `lv < 6`：0
  - `lv >= 6`：`(lv - 5) * 3`，上限 12

### 5.3 前端指令文本（用于“写入上下文记忆”）

前端会根据当前勾选房间生成一段可发送到聊天的文本（用于让主 AI 产出剧情与长期记忆）：

- `{{user}}指令伊甸将楼层XX的XXX、XXX房间……设为其生存庇护范围……进入该房间的角色将不再因恶劣天气扣减健康值。`

该文本仅是“叙事/记忆同步”，真正的自动结算依据仍是 chat 变量 `eden.shelter_scope`。

---

## 6) 正文/选项注入：`<content>` 与 `image###...###` 的踩坑与修复

### 6.1 读取策略（`useInjectedData`）

状态栏界面不再在 `useInjectedData` 阶段“拼装正文”，而是返回：

- `raw`：当前楼层消息原文
- `options`：从 `<option>...</option>` 中解析出的选项行数组

### 6.2 `StorySection` 的归一化目标

目标效果：

1. **正文里已经用 `<content>` 包裹了 `image###...###`**：不干预，正常解析显示（不会重复追加）
2. **正文里没有包裹 `image###...###`**（例如出现在 `<content>` 外）：把“块外”的 `image###...###` **移动进最后一个 `<content>/<game>` 块**（或在缺 `<content>` 时新建 `<content>`）
3. **缺 `<content>` 的历史遗留**：走 “B 策略”——把“非 `<option>` 部分”合成一个 `<content>`，保证正文可稳定显示

额外处理：

- 会隐藏 `<imgthink>...</imgthink>` 的内容
- 会去掉 `<image>...</image>` 的包裹标签，但保留内部 `image###...###`（供生图插件提取）

---

## 7) 构建与部署（给后续维护者）

### 7.1 构建命令

- 开发构建：`pnpm -s build:dev`

产物目录：

- 脚本：`dist/寒冬末日/脚本/**/index.js`
- 界面：`dist/寒冬末日/界面/**/index.html`

### 7.2 在酒馆助手中部署

- `dist/寒冬末日/脚本/变量结构/index.js`：作为“酒馆助手脚本（后台脚本）”部署（注册 Zod Schema）
- `dist/寒冬末日/脚本/日期逻辑/index.js`：作为“酒馆助手脚本（后台脚本）”部署（跨午夜自动补日期/末日天数）
- `dist/寒冬末日/脚本/离场健康结算/index.js`：作为“酒馆助手脚本（后台脚本）”部署
- `dist/寒冬末日/界面/状态栏/index.html`：作为“前端界面（消息楼层 iframe）”部署

如果需要“整页粘贴到正则替换”，优先使用构建生成的 `paste.html`（避免 JSON 反转义破坏脚本）。

---

## 8) 常见调试点（快速定位问题）

1. **离场健康没变**：
   - 检查本轮是否推进了 `世界.日期/时间`
   - 检查角色是否为 `登场状态: 离场`
   - 检查 AI 是否在本轮改过该角色的 `健康/健康更新原因`（改过则脚本跳过离场基础结算）
2. **房间庇护没生效**：
   - 检查 chat 变量 `eden.shelter_scope` 是否写入
   - 检查角色是否真的在某个 `楼层房间.楼层XX房间.房号.入住者` 中
   - `2001` 永远不需要/不允许设置（脚本视为受庇护）
3. **正文图片提示词重复/缺失**：
   - 推荐：AI 输出时把正文包在 `<content>`，并把 `image###...###` 写在 `<content>` 内
   - 历史遗留：`StorySection` 会尝试把块外 `image###...###` 移进正文，避免重复展示
