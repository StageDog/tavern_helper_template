{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/寒冬末日/util/time.ts","src://tavern_helper_template/src/寒冬末日/util/health.ts","src://tavern_helper_template/src/寒冬末日/脚本/离场健康结算/index.ts","src://tavern_helper_template/src/寒冬末日/util/shelter_scope.ts","src://tavern_helper_template/src/寒冬末日/util/room.ts"],"sourcesContent":["type ParsedWorldTime = {\n  epochMinutes: number;\n  hour: number;\n  minute: number;\n};\n\nfunction parseDateToEpochDay(dateStr: string): number | null {\n  // 格式：末日纪元，XXXX年XX月XX日\n  const m = (dateStr ?? '').match(/(\\d{1,4})年(\\d{1,2})月(\\d{1,2})日/);\n  if (!m) return null;\n  const year = Number(m[1]);\n  const month = Number(m[2]);\n  const day = Number(m[3]);\n  if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;\n  const d = new Date(year, month - 1, day);\n  if (Number.isNaN(d.getTime())) return null;\n  return Math.floor(d.getTime() / 86400000);\n}\n\nfunction parseTimeToMinutes(timeStr: string): { hour: number; minute: number } | null {\n  // 格式：时间段 - HH:MM\n  const m = (timeStr ?? '').match(/(\\d{1,2}):(\\d{2})/);\n  if (!m) return null;\n  const hour = Number(m[1]);\n  const minute = Number(m[2]);\n  if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;\n  if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;\n  return { hour, minute };\n}\n\nexport function parseWorldTime(dateStr: string, timeStr: string): ParsedWorldTime | null {\n  const day = parseDateToEpochDay(dateStr);\n  const hm = parseTimeToMinutes(timeStr);\n  if (day === null || hm === null) return null;\n  const epochMinutes = day * 1440 + hm.hour * 60 + hm.minute;\n  return { epochMinutes, hour: hm.hour, minute: hm.minute };\n}\n\nexport function diffWorldHours(\n  oldWorld: { 日期?: string; 时间?: string },\n  newWorld: { 日期?: string; 时间?: string },\n): number | null {\n  const oldParsed = parseWorldTime(oldWorld.日期 ?? '', oldWorld.时间 ?? '');\n  const newParsed = parseWorldTime(newWorld.日期 ?? '', newWorld.时间 ?? '');\n  if (!oldParsed || !newParsed) return null;\n  const diffMinutes = newParsed.epochMinutes - oldParsed.epochMinutes;\n  if (!Number.isFinite(diffMinutes)) return null;\n  if (diffMinutes <= 0) return null;\n  return diffMinutes / 60;\n}\n\n","export type HealthRules = {\n  decayPer6h: number;\n  recoverPer12h: number;\n  decayMultiplier: number;\n  recoverMultiplier: number;\n};\n\nexport function clampHealth(v: number): number {\n  return _.clamp(Number(v) || 0, 0, 100);\n}\n\nexport function healthCondition(health: number): string {\n  const h = clampHealth(health);\n  if (h <= 0) return '死亡';\n  if (h < 30) return '重病/濒死';\n  if (h < 60) return '生病/受伤';\n  if (h < 80) return '亚健康';\n  return '健康';\n}\n\nexport function computeOffstageHealthDelta(\n  deltaHours: number,\n  sheltered: boolean,\n  rules: HealthRules,\n): { delta: number; reason: string } {\n  const dh = Number(deltaHours);\n  if (!Number.isFinite(dh) || dh <= 0) return { delta: 0, reason: '0, 无变化' };\n\n  const decayPer6h = Math.max(0, Number(rules.decayPer6h) || 0);\n  const recoverPer12h = Math.max(0, Number(rules.recoverPer12h) || 0);\n  const decayMultiplier = Math.max(0, Number(rules.decayMultiplier) || 0);\n  const recoverMultiplier = Math.max(0, Number(rules.recoverMultiplier) || 0);\n\n  if (sheltered) {\n    const steps = Math.floor(dh / 12);\n    const delta = Math.floor(steps * recoverPer12h * recoverMultiplier);\n    if (!delta) return { delta: 0, reason: '0, 无变化' };\n    return { delta, reason: `+${delta}, 离场受庇护休整` };\n  }\n\n  const steps = Math.floor(dh / 6);\n  const delta = -Math.floor(steps * decayPer6h * decayMultiplier);\n  if (!delta) return { delta: 0, reason: '0, 无变化' };\n  return { delta, reason: `${delta}, 离场未受庇护自然衰减` };\n}\n\n","import { diffWorldHours } from '../../util/time';\nimport { findRoleLocation } from '../../util/room';\nimport { normalizeScope, ShelterScopeByFloor, isRoomSheltered } from '../../util/shelter_scope';\nimport { clampHealth, computeOffstageHealthDelta, healthCondition, HealthRules } from '../../util/health';\n\ntype RoleLike = {\n  健康?: number;\n  健康更新原因?: string;\n  健康状况?: string;\n  登场状态?: string;\n};\n\nfunction readShelterScopeFromChat(): ShelterScopeByFloor {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const raw = _.get(vars, 'eden.shelter_scope', {});\n  if (!raw || typeof raw !== 'object') return {};\n  return normalizeScope(raw as any);\n}\n\nfunction readHealthRulesFromChat(): HealthRules {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const raw = _.get(vars, 'eden.rules.health', {}) ?? {};\n  const r = raw as Partial<HealthRules>;\n  return {\n    decayPer6h: _.clamp(Number(r.decayPer6h) || 5, 0, 10),\n    recoverPer12h: _.clamp(Number(r.recoverPer12h) || 1, 0, 10),\n    decayMultiplier: _.clamp(Number(r.decayMultiplier) || 1, 0, 10),\n    recoverMultiplier: _.clamp(Number(r.recoverMultiplier) || 1, 0, 10),\n  };\n}\n\nfunction isShelteredForRole(stat_data: any, roleName: string, scope: ShelterScopeByFloor): boolean {\n  const rooms = _.get(stat_data, '房间', {});\n  const loc = findRoleLocation(rooms, roleName);\n  if (loc.kind === 'core' || loc.kind === 'entrance') return true;\n  if (loc.kind === 'floor') {\n    if (loc.floor === '20' && loc.roomNumber === '2001') return true;\n    return isRoomSheltered(scope, loc.floor, loc.roomNumber);\n  }\n  return false;\n}\n\nfunction isRoleLike(val: any): val is RoleLike {\n  return val && typeof val === 'object' && '健康' in val && '登场状态' in val;\n}\n\nfunction didAiTouchRole(oldRole: RoleLike | null, newRole: RoleLike): boolean {\n  if (!oldRole) return false;\n  const keys: Array<keyof RoleLike> = ['健康', '健康更新原因', '健康状况'];\n  const touched = keys.filter(k => !_.isEqual(oldRole[k], newRole[k]));\n  if (touched.length > 0) {\n    console.log(`[离场健康结算] ${newRole.姓名 || 'unknown'}: AI触碰字段=${touched.join(', ')}, old健康=${oldRole.健康}, new健康=${newRole.健康}`);\n  }\n  return touched.length > 0;\n}\n\nfunction applyOffstageRoleHealth(\n  rolePath: string,\n  roleName: string,\n  oldRole: RoleLike | null,\n  newRole: RoleLike,\n  stat_data: any,\n  deltaHours: number,\n  scope: ShelterScopeByFloor,\n  rules: HealthRules,\n) {\n  // 记录入口日志\n  console.log(`[离场健康结算] 检查角色: ${roleName}, 登场状态=${newRole.登场状态}, deltaHours=${deltaHours}`);\n\n  if (newRole.登场状态 !== '离场') {\n    console.log(`[离场健康结算] ${roleName}: 跳过，登场状态不是\"离场\"`);\n    return;\n  }\n\n  // 若 AI 在本轮触碰了该角色相关字段，视为\"剧情介入\"，脚本不接管\n  if (didAiTouchRole(oldRole, newRole)) {\n    console.log(`[离场健康结算] ${roleName}: AI已更新，跳过`);\n    return;\n  }\n\n  console.log(`[离场健康结算] ${roleName}: 开始处理, deltaHours=${deltaHours}, oldHealth=${oldRole?.健康}, newHealth=${newRole.健康}`);\n\n  const currentHealth = clampHealth(Number(newRole.健康) || 0);\n  const sheltered = isShelteredForRole(stat_data, roleName, scope);\n  console.log(`[离场健康结算] ${roleName}: currentHealth=${currentHealth}, sheltered=${sheltered}`);\n  const computed = computeOffstageHealthDelta(deltaHours, sheltered, rules);\n\n  const nextHealth = clampHealth(currentHealth + computed.delta);\n  const actualDelta = nextHealth - currentHealth;\n\n  const label = computed.reason.split(',').slice(1).join(',').trim() || (sheltered ? '离场受庇护休整' : '离场未受庇护自然衰减');\n  const reasonText = actualDelta\n    ? `${actualDelta > 0 ? `+${actualDelta}` : `${actualDelta}`}, ${label}`\n    : '0, 无变化';\n\n  _.set(stat_data, `${rolePath}.健康`, nextHealth);\n  _.set(stat_data, `${rolePath}.健康更新原因`, reasonText);\n  _.set(stat_data, `${rolePath}.健康状况`, healthCondition(nextHealth));\n\n  // 记录日志：哪些角色的健康值被脚本自动更新了\n  if (actualDelta !== 0) {\n    console.log(`[离场健康结算] ${roleName}: ${currentHealth} → ${nextHealth} (${reasonText})`);\n  } else if (computed.delta === 0) {\n    console.log(`[离场健康结算] ${roleName}: 跳过，deltaHours=${deltaHours}, sheltered=${sheltered}, computed.delta=${computed.delta}`);\n  }\n}\n\n$(async () => {\n  await waitGlobalInitialized('Mvu');\n\n  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, (new_variables, old_variables) => {\n    const oldWorld = _.get(old_variables, 'stat_data.世界', {});\n    const newWorld = _.get(new_variables, 'stat_data.世界', {});\n    const deltaHours = diffWorldHours(oldWorld, newWorld);\n    if (!deltaHours) return;\n\n    const stat_data = _.get(new_variables, 'stat_data', {});\n    const old_stat_data = _.get(old_variables, 'stat_data', {});\n\n    const scope = readShelterScopeFromChat();\n    const rules = readHealthRulesFromChat();\n\n    const reserved = new Set(['世界', '庇护所', '房间', '主线任务', '楼层其他住户', '临时NPC']);\n    for (const [key, val] of Object.entries(stat_data ?? {})) {\n      if (reserved.has(key)) continue;\n      if (typeof key !== 'string' || key.startsWith('_')) continue;\n      if (!isRoleLike(val)) continue;\n\n      const oldRole = (_.get(old_stat_data, key, null) as any) as RoleLike | null;\n      applyOffstageRoleHealth(key, key, oldRole, val as any, stat_data, deltaHours, scope, rules);\n    }\n\n    const tempNpc = _.get(stat_data, '临时NPC', {});\n    if (tempNpc && typeof tempNpc === 'object') {\n      for (const [name, val] of Object.entries(tempNpc)) {\n        if (typeof name !== 'string' || !name) continue;\n        if (!isRoleLike(val)) continue;\n\n        const oldRole = (_.get(old_stat_data, `临时NPC.${name}`, null) as any) as RoleLike | null;\n        applyOffstageRoleHealth(`临时NPC.${name}`, name, oldRole, val as any, stat_data, deltaHours, scope, rules);\n      }\n    }\n  });\n});\n","export type ShelterScopeByFloor = Record<string, string[]>;\n\nexport function floorRoomCapacity(level: number, floor: '20' | '19'): number {\n  const lv = Number(level);\n  if (!Number.isFinite(lv)) return 0;\n\n  if (floor === '20') {\n    // 设定：Lv3=3 间，Lv4=6 间，Lv5=12 间（封顶）\n    if (lv < 3) return 0;\n    if (lv === 3) return 3;\n    if (lv === 4) return 6;\n    return 12;\n  }\n\n  // 19 层从等级 6 开始\n  if (lv < 6) return 0;\n  return _.clamp((lv - 5) * 3, 0, 12);\n}\n\nexport function isRoomSheltered(scope: ShelterScopeByFloor, floor: '20' | '19', roomNumber: string): boolean {\n  const list = scope?.[floor] ?? [];\n  if (!Array.isArray(list)) return false;\n  return list.includes(roomNumber);\n}\n\nexport function normalizeScope(scope: ShelterScopeByFloor): ShelterScopeByFloor {\n  const out: ShelterScopeByFloor = {};\n  for (const [floor, rooms] of Object.entries(scope ?? {})) {\n    if (!Array.isArray(rooms)) continue;\n    out[floor] = _(rooms)\n      .filter((x: any) => typeof x === 'string' && x.trim())\n      .filter((room: string) => !(floor === '20' && room === '2001'))\n      .uniq()\n      .sortBy()\n      .value();\n  }\n  return out;\n}\n","export type RoomLocation =\n  | { kind: 'entrance'; room: '临时客房A' | '临时客房B' | '玄关' }\n  | { kind: 'core'; room: '主卧室' | '主浴室' }\n  | { kind: 'floor'; floor: '20' | '19'; roomNumber: string }\n  | { kind: 'none' };\n\ntype RoomsStatData = any;\n\nexport function findRoleLocation(rooms: RoomsStatData, roleName: string): RoomLocation {\n  const name = roleName ?? '';\n  if (!name) return { kind: 'none' };\n\n  const entranceA: string[] = _.get(rooms, '玄关.临时客房A入住者', []);\n  if (Array.isArray(entranceA) && entranceA.includes(name)) return { kind: 'entrance', room: '临时客房A' };\n\n  const entranceB: string[] = _.get(rooms, '玄关.临时客房B入住者', []);\n  if (Array.isArray(entranceB) && entranceB.includes(name)) return { kind: 'entrance', room: '临时客房B' };\n\n  const bedroom: string[] = _.get(rooms, '核心区.主卧室使用者', []);\n  if (Array.isArray(bedroom) && bedroom.includes(name)) return { kind: 'core', room: '主卧室' };\n\n  const bathroom: string[] = _.get(rooms, '核心区.主浴室使用者', []);\n  if (Array.isArray(bathroom) && bathroom.includes(name)) return { kind: 'core', room: '主浴室' };\n\n  const floor20: Record<string, any> = _.get(rooms, '楼层房间.楼层20房间', {});\n  if (floor20 && typeof floor20 === 'object') {\n    for (const [roomNumber, data] of Object.entries(floor20)) {\n      const residents: string[] = (data as any)?.入住者 ?? [];\n      if (Array.isArray(residents) && residents.includes(name)) return { kind: 'floor', floor: '20', roomNumber };\n    }\n  }\n\n  const floor19: Record<string, any> = _.get(rooms, '楼层房间.楼层19房间', {});\n  if (floor19 && typeof floor19 === 'object') {\n    for (const [roomNumber, data] of Object.entries(floor19)) {\n      const residents: string[] = (data as any)?.入住者 ?? [];\n      if (Array.isArray(residents) && residents.includes(name)) return { kind: 'floor', floor: '19', roomNumber };\n    }\n  }\n\n  return { kind: 'none' };\n}\n\n"],"names":["parseWorldTime","dateStr","timeStr","day","m","match","year","Number","month","isFinite","d","Date","isNaN","getTime","Math","floor","parseDateToEpochDay","hm","hour","minute","parseTimeToMinutes","epochMinutes","clampHealth","v","_","clamp","readShelterScopeFromChat","vars","getVariables","type","raw","get","scope","out","rooms","Object","entries","Array","isArray","filter","x","trim","room","uniq","sortBy","value","normalizeScope","isShelteredForRole","stat_data","roleName","loc","name","kind","entranceA","includes","entranceB","bedroom","bathroom","floor20","roomNumber","data","residents","floor19","findRoleLocation","list","isRoomSheltered","isRoleLike","val","applyOffstageRoleHealth","rolePath","oldRole","newRole","deltaHours","rules","console","log","touched","k","isEqual","length","join","didAiTouchRole","currentHealth","sheltered","computed","dh","delta","reason","decayPer6h","max","recoverPer12h","decayMultiplier","recoverMultiplier","steps","computeOffstageHealthDelta","nextHealth","actualDelta","label","split","slice","reasonText","set","health","h","healthCondition","$","async","waitGlobalInitialized","eventOn","Mvu","events","VARIABLE_UPDATE_ENDED","new_variables","old_variables","oldWorld","newWorld","oldParsed","newParsed","diffMinutes","diffWorldHours","old_stat_data","r","readHealthRulesFromChat","reserved","Set","key","has","startsWith","tempNpc"],"ignoreList":[],"sourceRoot":""}