function e(e,t){const n=function(e){const t=(e??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]),o=Number(t[3]);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(o))return null;const i=new Date(n,r-1,o);return Number.isNaN(i.getTime())?null:Math.floor(i.getTime()/864e5)}(e),r=function(e){const t=(e??'').match(/(\d{1,2}):(\d{2})/);if(!t)return null;const n=Number(t[1]),r=Number(t[2]);return Number.isFinite(n)&&Number.isFinite(r)?n<0||n>23||r<0||r>59?null:{hour:n,minute:r}:null}(t);if(null===n||null===r)return null;return{epochMinutes:1440*n+60*r.hour+r.minute,hour:r.hour,minute:r.minute}}function t(e){return _.clamp(Number(e)||0,0,100)}function n(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.shelter_scope',{});return t&&'object'==typeof t?function(e){const t={};for(const[n,r]of Object.entries(e??{}))Array.isArray(r)&&(t[n]=_(r).filter(e=>'string'==typeof e&&e.trim()).filter(e=>!('20'===n&&'2001'===e)).uniq().sortBy().value());return t}(t):{}}function r(e,t,n){const r=function(e,t){const n=t??'';if(!n)return{kind:'none'};const r=_.get(e,'玄关.临时客房A入住者',[]);if(Array.isArray(r)&&r.includes(n))return{kind:'entrance',room:'临时客房A'};const o=_.get(e,'玄关.临时客房B入住者',[]);if(Array.isArray(o)&&o.includes(n))return{kind:'entrance',room:'临时客房B'};const i=_.get(e,'核心区.主卧室使用者',[]);if(Array.isArray(i)&&i.includes(n))return{kind:'core',room:'主卧室'};const u=_.get(e,'核心区.主浴室使用者',[]);if(Array.isArray(u)&&u.includes(n))return{kind:'core',room:'主浴室'};const c=_.get(e,'楼层房间.楼层20房间',{});if(c&&'object'==typeof c)for(const[e,t]of Object.entries(c)){const r=t?.入住者??[];if(Array.isArray(r)&&r.includes(n))return{kind:'floor',floor:'20',roomNumber:e}}const s=_.get(e,'楼层房间.楼层19房间',{});if(s&&'object'==typeof s)for(const[e,t]of Object.entries(s)){const r=t?.入住者??[];if(Array.isArray(r)&&r.includes(n))return{kind:'floor',floor:'19',roomNumber:e}}return{kind:'none'}}(_.get(e,'房间',{}),t);return'core'===r.kind||'entrance'===r.kind||'floor'===r.kind&&('20'===r.floor&&'2001'===r.roomNumber||function(e,t,n){const r=e?.[t]??[];return!!Array.isArray(r)&&r.includes(n)}(n,r.floor,r.roomNumber))}function o(e){return e&&'object'==typeof e&&'健康'in e&&'登场状态'in e}function i(e,t){return e?{health:!_.isEqual(e.健康,t.健康),healthReason:!_.isEqual(e.健康更新原因,t.健康更新原因),relation:!_.isEqual(e.关系,t.关系),relationTendency:!_.isEqual(e.关系倾向,t.关系倾向),imprint:!_.isEqual(e.秩序刻印,t.秩序刻印),imprintReason:!_.isEqual(e.秩序刻印更新原因,t.秩序刻印更新原因)}:{health:!1,healthReason:!1,relation:!1,relationTendency:!1,imprint:!1,imprintReason:!1}}function u(e,n,o,u,c,s,a,l){if('离场'!==u.登场状态)return;if(!o)return;if(null===s)return;const f=i(o,u);if(f.health||f.healthReason)return;const m=t(Number(u.健康)||0),b=r(c,n,a),d=function(e,t,n){const r=Number(e);if(!Number.isFinite(r)||r<=0)return{delta:0,reason:'0, 无变化'};const o=Math.max(0,Number(n.decayPer6h)||0),i=Math.max(0,Number(n.recoverPer12h)||0),u=Math.max(0,Number(n.decayMultiplier)||0),c=Math.max(0,Number(n.recoverMultiplier)||0);if(t){const e=Math.floor(r/12),t=Math.floor(e*i*c);return t?{delta:t,reason:`+${t}, 离场受庇护休整`}:{delta:0,reason:'0, 无变化'}}const s=Math.floor(r/6),a=-Math.floor(s*o*u);return a?{delta:a,reason:`${a}, 离场未受庇护自然衰减`}:{delta:0,reason:'0, 无变化'}}(s,b,l);if(!d.delta)return;const h=t(m+d.delta),N=h-m,y=d.reason.split(',').slice(1).join(',').trim()||(b?'离场受庇护休整':'离场未受庇护自然衰减'),p=N?`${N>0?`+${N}`:`${N}`}, ${y}`:'0, 无变化';_.set(c,`${e}.健康`,h),_.set(c,`${e}.健康更新原因`,p),console.log(`[离场健康结算] ${n}: ${m} → ${h} (${p})`)}function c(e,n,r){const o=function(e){const n=t(e);return n<=0?'死亡':n<30?'重病/濒死':n<60?'生病/受伤':n<80?'亚健康':'健康'}(t(Number(n.健康)||0));n.健康状况!==o&&_.set(r,`${e}.健康状况`,o)}function s(e,t,n,r){const o=n.秩序刻印;if('number'!=typeof o&&'string'!=typeof o)return;const u=function(e){const t=_.clamp(Number(e)||0,0,100);return t<20?'拒绝':t<40?'交易':t<60?'顺从':t<90?'忠诚':'性奴'}(Number(o));i(t,n).relation||n.关系!==u&&_.set(r,`${e}.关系`,u)}$(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(t,r)=>{const i=function(t,n){const r=e(t.日期??'',t.时间??''),o=e(n.日期??'',n.时间??'');if(!r||!o)return null;const i=o.epochMinutes-r.epochMinutes;return Number.isFinite(i)?i<=0?null:i/60:null}(_.get(r,'stat_data.世界',{}),_.get(t,'stat_data.世界',{})),a=_.get(t,'stat_data',{}),l=_.get(r,'stat_data',{}),f=n(),m=function(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.rules.health',{})??{};return{decayPer6h:_.clamp(Number(t.decayPer6h)||5,0,10),recoverPer12h:_.clamp(Number(t.recoverPer12h)||1,0,10),decayMultiplier:_.clamp(Number(t.decayMultiplier)||1,0,10),recoverMultiplier:_.clamp(Number(t.recoverMultiplier)||1,0,10)}}(),b=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']);for(const[e,t]of Object.entries(a??{})){if(b.has(e))continue;if('string'!=typeof e||e.startsWith('_'))continue;if(!o(t))continue;const n=_.get(l,e,null);u(e,e,n,t,a,i,f,m),c(e,t,a),s(e,n,t,a)}const d=_.get(a,'临时NPC',{});if(d&&'object'==typeof d)for(const[e,t]of Object.entries(d)){if('string'!=typeof e||!e)continue;if(!o(t))continue;const n=_.get(l,`临时NPC.${e}`,null);u(`临时NPC.${e}`,e,n,t,a,i,f,m),c(`临时NPC.${e}`,t,a),s(`临时NPC.${e}`,n,t,a)}})});
//# sourceMappingURL=index.js.map