function e(e,t){const n=function(e){const t=(e??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!t)return null;const n=Number(t[1]),o=Number(t[2]),r=Number(t[3]);if(!Number.isFinite(n)||!Number.isFinite(o)||!Number.isFinite(r))return null;const i=new Date(n,o-1,r);return Number.isNaN(i.getTime())?null:Math.floor(i.getTime()/864e5)}(e),o=function(e){const t=(e??'').match(/(\d{1,2}):(\d{2})/);if(!t)return null;const n=Number(t[1]),o=Number(t[2]);return Number.isFinite(n)&&Number.isFinite(o)?n<0||n>23||o<0||o>59?null:{hour:n,minute:o}:null}(t);if(null===n||null===o)return null;return{epochMinutes:1440*n+60*o.hour+o.minute,hour:o.hour,minute:o.minute}}function t(e){return _.clamp(Number(e)||0,0,100)}function n(e){const t=(e??'').match(/(\d{1,2}):(\d{2})/);if(!t)return null;const n=Number(t[1]),o=Number(t[2]);return Number.isFinite(n)&&Number.isFinite(o)?n<0||n>23||o<0||o>59?null:60*n+o:null}function o(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.shelter_scope',{});return t&&'object'==typeof t?function(e){const t={};for(const[n,o]of Object.entries(e??{}))Array.isArray(o)&&(t[n]=_(o).filter(e=>'string'==typeof e&&e.trim()).filter(e=>!('20'===n&&'2001'===e)).uniq().sortBy().value());return t}(t):{}}function r(e,t,n){const o=function(e,t){const n=t??'';if(!n)return{kind:'none'};const o=_.get(e,'玄关.临时客房A入住者',[]);if(Array.isArray(o)&&o.includes(n))return{kind:'entrance',room:'临时客房A'};const r=_.get(e,'玄关.临时客房B入住者',[]);if(Array.isArray(r)&&r.includes(n))return{kind:'entrance',room:'临时客房B'};const i=_.get(e,'核心区.主卧室使用者',[]);if(Array.isArray(i)&&i.includes(n))return{kind:'core',room:'主卧室'};const a=_.get(e,'核心区.主浴室使用者',[]);if(Array.isArray(a)&&a.includes(n))return{kind:'core',room:'主浴室'};const s=_.get(e,'楼层房间.楼层20房间',{});if(s&&'object'==typeof s)for(const[e,t]of Object.entries(s)){const o=t?.入住者??[];if(Array.isArray(o)&&o.includes(n))return{kind:'floor',floor:'20',roomNumber:e}}const c=_.get(e,'楼层房间.楼层19房间',{});if(c&&'object'==typeof c)for(const[e,t]of Object.entries(c)){const o=t?.入住者??[];if(Array.isArray(o)&&o.includes(n))return{kind:'floor',floor:'19',roomNumber:e}}return{kind:'none'}}(_.get(e,'房间',{}),t);return'core'===o.kind||'entrance'===o.kind||'floor'===o.kind&&('20'===o.floor&&'2001'===o.roomNumber||function(e,t,n){const o=e?.[t]??[];return!!Array.isArray(o)&&o.includes(n)}(n,o.floor,o.roomNumber))}function i(e){return e&&'object'==typeof e&&'健康'in e&&'登场状态'in e}function a(e,t){return e?{health:!_.isEqual(e.健康,t.健康),healthReason:!_.isEqual(e.健康更新原因,t.健康更新原因),relation:!_.isEqual(e.关系,t.关系),relationTendency:!_.isEqual(e.关系倾向,t.关系倾向),imprint:!_.isEqual(e.秩序刻印,t.秩序刻印),imprintReason:!_.isEqual(e.秩序刻印更新原因,t.秩序刻印更新原因)}:{health:!1,healthReason:!1,relation:!1,relationTendency:!1,imprint:!1,imprintReason:!1}}function s(e,n,o,i,s,c,l,u,d){if('离场'!==i.登场状态)return;if(!o)return;if(null===c)return;const f=a(o,i);if(f.health||f.healthReason)return void(d?.offstageHealth&&console.log(`[OffstageHealth] skip(${n}): touched by AI (health=${f.health}, reason=${f.healthReason})`));const g=t(Number(i.健康)||0),m=r(s,n,l),h=function(e,t,n){const o=Number(e);if(!Number.isFinite(o)||o<=0)return{delta:0,reason:'0, 无变化'};const r=Math.max(0,Number(n.decayPer6h)||0),i=Math.max(0,Number(n.recoverPer12h)||0),a=Math.max(0,Number(n.decayMultiplier)||0),s=Math.max(0,Number(n.recoverMultiplier)||0);if(t){const e=Math.floor(o/12),t=Math.floor(e*i*s);return t?{delta:t,reason:`+${t}, 离场受庇护休整`}:{delta:0,reason:'0, 无变化'}}const c=Math.floor(o/6),l=-Math.floor(c*r*a);return l?{delta:l,reason:`${l}, 离场未受庇护自然衰减`}:{delta:0,reason:'0, 无变化'}}(c,m,u);if(!h.delta)return void(d?.offstageHealth&&console.log(`[OffstageHealth] no-op(${n}): dh=${c.toFixed(2)}, sheltered=${m}`));const b=t(g+h.delta),N=b-g,y=h.reason.split(',').slice(1).join(',').trim()||(m?'离场受庇护休整':'离场未受庇护自然衰减'),p=N?`${N>0?`+${N}`:`${N}`}, ${y}`:'0, 无变化';_.set(s,`${e}.健康`,b),_.set(s,`${e}.健康更新原因`,p),console.log(`[离场健康结算] ${n}: ${g} → ${b} (${p})`)}function c(e,n,o){const r=function(e){const n=t(e);return n<=0?'死亡':n<30?'重病/濒死':n<60?'生病/受伤':n<80?'亚健康':'健康'}(t(Number(n.健康)||0));n.健康状况!==r&&_.set(o,`${e}.健康状况`,r)}function l(e,t,n,o){const r=n.秩序刻印;if('number'!=typeof r&&'string'!=typeof r)return;const i=function(e){const t=_.clamp(Number(e)||0,0,100);return t<20?'拒绝':t<40?'交易':t<60?'顺从':t<90?'忠诚':'性奴'}(Number(r));a(t,n).relation||n.关系!==i&&_.set(o,`${e}.关系`,i)}$(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(t,r)=>{const a=function(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.debug',{})??{};return{dateLogic:!0===_.get(t,'date_logic',!1),offstageHealth:!0===_.get(t,'offstage_health',!1)}}(),u=_.get(r,'stat_data.世界',{});{const e=_.get(r,'stat_data.世界.时间',''),o=_.get(t,'stat_data.世界.时间','');if(e!==o){const i=n(e),s=n(o);if(null!==i&&null!==s&&i>s){console.log(`[DateLogic] Detected midnight crossing: ${e} -> ${o}`);const n=_.get(r,'stat_data.世界.日期',''),i=_.get(t,'stat_data.世界.日期','');if(n===i){console.log('[DateLogic] AI did not update date, patching date/day...');const e=function(e){const t=(e??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!t)return null;const n=Number(t[1]),o=Number(t[2]),r=Number(t[3]);return Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(r)?{year:n,month:o,day:r}:null}(n);if(e){const o=new Date(e.year,e.month-1,e.day);if(Number.isNaN(o.getTime()))a.dateLogic&&console.log(`[DateLogic] cannot parse date to Date(): ${n}`);else{o.setDate(o.getDate()+1);const e=`末日纪元，${(d=o).getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;_.set(t,'stat_data.世界.日期',e);const r=_.get(t,'stat_data.世界.末日天数');'number'==typeof r&&_.set(t,'stat_data.世界.末日天数',r+1);const i=_.get(t,'stat_data.世界.末日天数');console.log(`[DateLogic] patched date: ${n} -> ${e}; days: ${r} -> ${i}`)}}else a.dateLogic&&console.log(`[DateLogic] cannot parse date string: ${n}`)}else a.dateLogic&&console.log(`[DateLogic] date already updated by AI: ${n} -> ${i}`)}else a.dateLogic&&console.log(`[DateLogic] time changed but not crossing: ${e} -> ${o} (oldMin=${i}, newMin=${s})`)}else a.dateLogic&&console.log('[DateLogic] time unchanged; no date check.')}var d;const f=_.get(t,'stat_data.世界',{}),g=function(t,n){const o=e(t.日期??'',t.时间??''),r=e(n.日期??'',n.时间??'');if(!o||!r)return null;const i=r.epochMinutes-o.epochMinutes;return Number.isFinite(i)?i<=0?null:i/60:null}(u,f);if(null===g){_.get(r,'stat_data.世界.时间','')!==_.get(t,'stat_data.世界.时间','')?console.log('[DateLogic] diffWorldHours=null',{oldWorld:u,newWorld:f}):a.dateLogic&&console.log('[DateLogic] diffWorldHours=null (time unchanged)',{oldWorld:u,newWorld:f})}else a.dateLogic&&console.log(`[DateLogic] diffWorldHours=${g.toFixed(2)}`);const m=_.get(t,'stat_data',{}),h=_.get(r,'stat_data',{}),b=o(),N=function(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.rules.health',{})??{};return{decayPer6h:_.clamp(Number(t.decayPer6h)||5,0,10),recoverPer12h:_.clamp(Number(t.recoverPer12h)||1,0,10),decayMultiplier:_.clamp(Number(t.decayMultiplier)||1,0,10),recoverMultiplier:_.clamp(Number(t.recoverMultiplier)||1,0,10)}}(),y=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']);for(const[e,t]of Object.entries(m??{})){if(y.has(e))continue;if('string'!=typeof e||e.startsWith('_'))continue;if(!i(t))continue;const n=_.get(h,e,null);s(e,e,n,t,m,g,b,N,a),c(e,t,m),l(e,n,t,m)}const p=_.get(m,'临时NPC',{});if(p&&'object'==typeof p)for(const[e,t]of Object.entries(p)){if('string'!=typeof e||!e)continue;if(!i(t))continue;const n=_.get(h,`临时NPC.${e}`,null);s(`临时NPC.${e}`,e,n,t,m,g,b,N,a),c(`临时NPC.${e}`,t,m),l(`临时NPC.${e}`,n,t,m)}})});
//# sourceMappingURL=index.js.map