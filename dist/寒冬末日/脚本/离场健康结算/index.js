function e(e,t){const r=function(e){const t=(e??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!t)return null;const r=Number(t[1]),n=Number(t[2]),o=Number(t[3]);if(!Number.isFinite(r)||!Number.isFinite(n)||!Number.isFinite(o))return null;const i=new Date(r,n-1,o);return Number.isNaN(i.getTime())?null:Math.floor(i.getTime()/864e5)}(e),n=function(e){const t=(e??'').match(/(\d{1,2}):(\d{2})/);if(!t)return null;const r=Number(t[1]),n=Number(t[2]);return Number.isFinite(r)&&Number.isFinite(n)?r<0||r>23||n<0||n>59?null:{hour:r,minute:n}:null}(t);if(null===r||null===n)return null;return{epochMinutes:1440*r+60*n.hour+n.minute,hour:n.hour,minute:n.minute}}function t(e){return _.clamp(Number(e)||0,0,100)}function r(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.shelter_scope',{});return t&&'object'==typeof t?function(e){const t={};for(const[r,n]of Object.entries(e??{}))Array.isArray(n)&&(t[r]=_(n).filter(e=>'string'==typeof e&&e.trim()).filter(e=>!('20'===r&&'2001'===e)).uniq().sortBy().value());return t}(t):{}}function n(e,t,r){const n=function(e,t){const r=t??'';if(!r)return{kind:'none'};const n=_.get(e,'玄关.临时客房A入住者',[]);if(Array.isArray(n)&&n.includes(r))return{kind:'entrance',room:'临时客房A'};const o=_.get(e,'玄关.临时客房B入住者',[]);if(Array.isArray(o)&&o.includes(r))return{kind:'entrance',room:'临时客房B'};const i=_.get(e,'核心区.主卧室使用者',[]);if(Array.isArray(i)&&i.includes(r))return{kind:'core',room:'主卧室'};const u=_.get(e,'核心区.主浴室使用者',[]);if(Array.isArray(u)&&u.includes(r))return{kind:'core',room:'主浴室'};const c=_.get(e,'楼层房间.楼层20房间',{});if(c&&'object'==typeof c)for(const[e,t]of Object.entries(c)){const n=t?.入住者??[];if(Array.isArray(n)&&n.includes(r))return{kind:'floor',floor:'20',roomNumber:e}}const l=_.get(e,'楼层房间.楼层19房间',{});if(l&&'object'==typeof l)for(const[e,t]of Object.entries(l)){const n=t?.入住者??[];if(Array.isArray(n)&&n.includes(r))return{kind:'floor',floor:'19',roomNumber:e}}return{kind:'none'}}(_.get(e,'房间',{}),t);return'core'===n.kind||'entrance'===n.kind||'floor'===n.kind&&('20'===n.floor&&'2001'===n.roomNumber||function(e,t,r){const n=e?.[t]??[];return!!Array.isArray(n)&&n.includes(r)}(r,n.floor,n.roomNumber))}function o(e){return e&&'object'==typeof e&&'健康'in e&&'登场状态'in e}function i(e,r,o,i,u,c,l,s){if(console.log(`[离场健康结算] 检查角色: ${r}, 登场状态=${i.登场状态}, deltaHours=${c}`),'离场'!==i.登场状态)return void console.log(`[离场健康结算] ${r}: 跳过，登场状态不是"离场"`);if(function(e,t){if(!e)return!1;const r=['健康','健康更新原因','健康状况'].filter(r=>!_.isEqual(e[r],t[r]));return r.length>0&&console.log(`[离场健康结算] ${t.姓名||'unknown'}: AI触碰字段=${r.join(', ')}, old健康=${e.健康}, new健康=${t.健康}`),r.length>0}(o,i))return void console.log(`[离场健康结算] ${r}: AI已更新，跳过`);console.log(`[离场健康结算] ${r}: 开始处理, deltaHours=${c}, oldHealth=${o?.健康}, newHealth=${i.健康}`);const a=t(Number(i.健康)||0),f=n(u,r,l);console.log(`[离场健康结算] ${r}: currentHealth=${a}, sheltered=${f}`);const m=function(e,t,r){const n=Number(e);if(!Number.isFinite(n)||n<=0)return{delta:0,reason:'0, 无变化'};const o=Math.max(0,Number(r.decayPer6h)||0),i=Math.max(0,Number(r.recoverPer12h)||0),u=Math.max(0,Number(r.decayMultiplier)||0),c=Math.max(0,Number(r.recoverMultiplier)||0);if(t){const e=Math.floor(n/12),t=Math.floor(e*i*c);return t?{delta:t,reason:`+${t}, 离场受庇护休整`}:{delta:0,reason:'0, 无变化'}}const l=Math.floor(n/6),s=-Math.floor(l*o*u);return s?{delta:s,reason:`${s}, 离场未受庇护自然衰减`}:{delta:0,reason:'0, 无变化'}}(c,f,s),d=t(a+m.delta),b=d-a,h=m.reason.split(',').slice(1).join(',').trim()||(f?'离场受庇护休整':'离场未受庇护自然衰减'),N=b?`${b>0?`+${b}`:`${b}`}, ${h}`:'0, 无变化';_.set(u,`${e}.健康`,d),_.set(u,`${e}.健康更新原因`,N),_.set(u,`${e}.健康状况`,function(e){const r=t(e);return r<=0?'死亡':r<30?'重病/濒死':r<60?'生病/受伤':r<80?'亚健康':'健康'}(d)),0!==b?console.log(`[离场健康结算] ${r}: ${a} → ${d} (${N})`):0===m.delta&&console.log(`[离场健康结算] ${r}: 跳过，deltaHours=${c}, sheltered=${f}, computed.delta=${m.delta}`)}$(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(t,n)=>{const u=function(t,r){const n=e(t.日期??'',t.时间??''),o=e(r.日期??'',r.时间??'');if(!n||!o)return null;const i=o.epochMinutes-n.epochMinutes;return Number.isFinite(i)?i<=0?null:i/60:null}(_.get(n,'stat_data.世界',{}),_.get(t,'stat_data.世界',{}));if(!u)return;const c=_.get(t,'stat_data',{}),l=_.get(n,'stat_data',{}),s=r(),a=function(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.rules.health',{})??{};return{decayPer6h:_.clamp(Number(t.decayPer6h)||5,0,10),recoverPer12h:_.clamp(Number(t.recoverPer12h)||1,0,10),decayMultiplier:_.clamp(Number(t.decayMultiplier)||1,0,10),recoverMultiplier:_.clamp(Number(t.recoverMultiplier)||1,0,10)}}(),f=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']);for(const[e,t]of Object.entries(c??{})){if(f.has(e))continue;if('string'!=typeof e||e.startsWith('_'))continue;if(!o(t))continue;i(e,e,_.get(l,e,null),t,c,u,s,a)}const m=_.get(c,'临时NPC',{});if(m&&'object'==typeof m)for(const[e,t]of Object.entries(m)){if('string'!=typeof e||!e)continue;if(!o(t))continue;i(`临时NPC.${e}`,e,_.get(l,`临时NPC.${e}`,null),t,c,u,s,a)}})});
//# sourceMappingURL=index.js.map